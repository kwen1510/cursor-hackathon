<!DOCTYPE html>
<html>
<head>
    <title>Teach(er) - Lesson Analysis Assistant</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Teach(er)">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <meta name="description" content="Record, transcribe, and analyze your teaching with AI-powered insights">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg: #fafbfc;
            --panel: #ffffff;
            --border: #e5e7eb;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --text: #111827;
            --muted: #6b7280;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; overflow-x: hidden; }
        body { margin: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); font-weight: 400; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; letter-spacing: -0.01em; }
        .app { display: grid; grid-template-rows: 64px 1fr; height: 100vh; overflow-x: hidden; }
        .topbar { display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: #ffffff; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 2; }
        .topbar h1 { font-size: 18px; margin: 0; letter-spacing: .3px; }
        .topbar .topbar-left { display: flex; align-items: center; gap: 20px; }
        .topbar .mode-nav { display: flex; gap: 4px; background: #f3f4f6; border-radius: 8px; padding: 4px; }
        .topbar .mode-btn { padding: 8px 16px; border: none; background: transparent; color: var(--muted); font-size: 14px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .topbar .mode-btn:hover { color: var(--text); }
        .topbar .mode-btn.active { background: #ffffff; color: var(--text); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .topbar .actions { display: flex; gap: 10px; align-items: center; }
        .select { background: #ffffff; border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 8px 10px; }
        .hidden { display: none !important; }

        .main { display: flex; gap: 12px; padding: 20px; min-height: 0; height: calc(100vh - 64px); overflow-x: hidden; max-width: 100vw; }
        .left { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; min-height: 0; display: grid; grid-template-rows: 1fr; flex: 1 1 58%; min-width: 0; }
        .player-wrap { padding: 20px; }
        /* Draggable divider between panels */
        .divider { width: 6px; cursor: col-resize; background: #e5e7eb; border-radius: 6px; align-self: stretch; flex-shrink: 0; }
        .divider:hover { background: #cbd5e1; }

        .right { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; min-height: 0; display: flex; flex-direction: column; flex: 1 1 38%; min-width: 0; overflow-x: hidden; }
        .right-header { display: flex; border-bottom: 1px solid var(--border); }
        .tab { padding: 12px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab.active { border-bottom-color: var(--accent); background: rgba(37, 99, 235, 0.05); }
        .tab:hover { background: rgba(37, 99, 235, 0.02); }
        .right-content { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .right-content.hidden { display: none; }

        .time-item { margin-bottom: 12px; display: flex; align-items: flex-start; gap: 8px; }
        .seek-btn { flex: 1; background: #ffffff; border: 1px solid var(--border); color: #0f172a; padding: 14px 16px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: box-shadow .15s ease, transform .15s ease; display: flex; align-items: flex-start; gap: 12px; text-align: left; box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06); position: relative; }
        .seek-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12); }
        .seek-btn:active { transform: translateY(0); }
        .seek-btn.role-teacher { border-left: 4px solid #3b82f6; }
        .seek-btn.role-student { border-left: 4px solid #10b981; }
        .time-chip { background: #f1f5f9; border: 1px solid var(--border); color: #0f172a; padding: 4px 10px; border-radius: 999px; font-weight: 800; font-size: 12px; letter-spacing: 0.3px; white-space: nowrap; font-variant-numeric: tabular-nums; }
        .time-body { color: #0f172a; line-height: 1.35; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .time-item-side { display: flex; flex-direction: column; align-items: center; gap: 4px; padding-top: 14px; }
        .flag-btn { background: transparent; border: none; cursor: pointer; font-size: 18px; opacity: 0.5; transition: all 0.2s; padding: 4px; filter: grayscale(100%); }
        .flag-btn:hover { opacity: 1; transform: scale(1.15); }
        .flag-btn.flagged { opacity: 1; filter: grayscale(0%); }
        .flagged-item { background: #ffffff; border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
        .flagged-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
        .flagged-actions { display: flex; gap: 8px; }
        .publish-note-btn { margin-top: 8px; padding: 6px 14px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .publish-note-btn:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); }
        .publish-note-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .publish-note-btn.published { background: #10b981; }
        .publish-note-btn.published:hover { background: #059669; }
        .publish-note-btn.update { background: #f59e0b; }
        .publish-note-btn.update:hover { background: #d97706; }
        .flag-note-wrapper { position: relative; margin-top: 8px; }
        .flag-note { width: 100%; padding: 8px 52px 8px 8px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; resize: vertical; min-height: 60px; font-family: inherit; }
        .note-mic-btn { position: absolute; right: 8px; bottom: 8px; width: 36px; height: 36px; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #9ca3af; transition: all 0.2s ease; padding: 0; }
        .note-mic-btn:hover { color: #6b7280; transform: scale(1.08); }
        .note-mic-btn:active { transform: scale(0.95); }
        .note-mic-btn.recording { color: #ef4444; animation: pulse-icon 1.2s ease-in-out infinite; }
        @keyframes pulse-icon { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse-recording { 0%, 100% { transform: scale(1); box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3); } 50% { transform: scale(1.05); box-shadow: 0 12px 48px rgba(239, 68, 68, 0.5); } }
        .recording-active { animation: pulse-recording 2s ease-in-out infinite !important; }
        
        .suggested-question-btn:hover {
            background: #f8fafc !important;
            border-color: #3b82f6 !important;
            color: #3b82f6 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #aiAnalysisMicBtn:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        
        #aiAnalysisMicBtn.recording {
            background: #ef4444;
            animation: pulse-icon 1.2s ease-in-out infinite;
        }
        
        #aiAnalysisSendBtn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .ai-response-content strong {
            color: #1e40af;
            font-weight: 600;
        }
        
        .ai-response-content {
            word-wrap: break-word;
        }
        
        #goalsResearchAnalysisBtn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        #player { aspect-ratio: 16/9; background: #eef2ff; border-radius: 10px; }


        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; }
        .chat-input-area { border-top: 1px solid var(--border); padding: 20px; background: var(--panel); }
        
        .chat-message { margin-bottom: 16px; }
        .chat-message:last-child { margin-bottom: 0; }
        .chat-message.user { text-align: right; }
        .chat-message.assistant { text-align: left; }
        .chat-bubble { 
            display: inline-block; 
            max-width: 85%; 
            padding: 12px 16px; 
            border-radius: 16px; 
            line-height: 1.5; 
            word-wrap: break-word;
        }
        .chat-bubble.user { 
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); 
            color: white; 
            border-bottom-right-radius: 4px;
        }
        .chat-bubble.assistant { 
            background: #f8fafc; 
            color: #1e293b; 
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 4px;
        }

        /* Lightweight markdown styling for assistant replies */
        .chat-bubble.assistant.md { padding: 14px 18px; }
        .chat-bubble.assistant.md h1,
        .chat-bubble.assistant.md h2,
        .chat-bubble.assistant.md h3 { margin: 0 0 8px 0; font-weight: 800; line-height: 1.25; }
        .chat-bubble.assistant.md h1 { font-size: 18px; }
        .chat-bubble.assistant.md h2 { font-size: 16px; }
        .chat-bubble.assistant.md h3 { font-size: 15px; }
        .chat-bubble.assistant.md p { margin: 8px 0; }
        .chat-bubble.assistant.md strong { font-weight: 800; }
        .chat-bubble.assistant.md em { font-style: italic; }
        .chat-bubble.assistant.md ul { margin: 8px 0 8px 18px; padding: 0; list-style: disc; }
        .chat-bubble.assistant.md ol { margin: 8px 0 8px 20px; padding: 0; list-style: decimal; }
        .chat-bubble.assistant.md li { margin: 4px 0; }
        .chat-bubble.assistant.md code { background: #f1f5f9; padding: 2px 6px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .chat-bubble.assistant.md blockquote { border-left: 3px solid #cbd5e1; padding-left: 10px; color: #475569; margin: 8px 0; }
        .chat-bubble.assistant a.ts-link { color: var(--accent); text-decoration: none; font-weight: 800; }
        .chat-bubble.assistant a.ts-link:hover { text-decoration: underline; }

        @media (max-width: 1100px) { .main { flex-direction: column; } }
    </style>
</head>
<body>
<div class="app">
    <div class="topbar">
        <div class="topbar-left">
            <h1>Teach(er)</h1>
            <div class="mode-nav">
                <button class="mode-btn" data-mode="onboarding">Onboarding</button>
                <button class="mode-btn active" data-mode="lesson_analysis">Analysis</button>
                <button class="mode-btn" data-mode="progress">Progress</button>
                <button class="mode-btn" data-mode="record">Record</button>
            </div>
        </div>
        <div class="actions" id="lessonSelector">
            <label for="videoSelect" class="meta">Lesson</label>
            <select id="videoSelect" class="select"></select>
        </div>
        <div class="actions hidden" id="recordActions">
            <label for="recordingsDropdownTop" class="meta">Recordings</label>
            <select id="recordingsDropdownTop" class="select" title="Local recordings" style="max-width: 260px;"></select>
            <button id="loadRecordingTopBtn" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; background: #fff; font-size: 12px; font-weight: 600; cursor: pointer;">Load</button>
            <audio id="topPlaybackAudio" controls style="display:none; width: 220px;"></audio>
        </div>
    </div>
    <div class="main" id="mainContent">
        <!-- Onboarding Mode View -->
        <div id="onboardingView" class="hidden" style="flex: 1; display: flex; overflow: hidden;">
            <!-- Chat Container (Left Side) -->
            <div id="onboardingChat" style="flex: 1; display: flex; flex-direction: column; padding: 20px; overflow: hidden;">
                <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 24px 32px; margin-bottom: 16px;">
                    <h1 style="font-size: 24px; font-weight: 700; margin: 0 0 8px 0;">🎓 Onboarding Assistant</h1>
                    <p style="font-size: 14px; color: var(--muted); margin: 0;">Let's discuss your teaching goals and set up your lesson analysis.</p>
                </div>
                
                <!-- Chat Messages Container -->
                <div id="onboardingMessages" style="flex: 1; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 24px; overflow-y: auto; margin-bottom: 16px; display: flex; flex-direction: column; gap: 16px;">
                    <!-- Messages will be added here dynamically -->
                </div>
                
                <!-- Chat Input Area -->
                <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button id="onboardingMicBtn" style="flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; background: #3b82f6; color: white; border: none; cursor: pointer; transition: all 0.2s;" title="Voice input">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v3m0 0h-3m3 0h3M8.25 9v3a3.75 3.75 0 007.5 0V9m-7.5 0A3.75 3.75 0 0112 5.25v0A3.75 3.75 0 0115.75 9v3A3.75 3.75 0 0112 15.75v0A3.75 3.75 0 018.25 12V9z" />
                            </svg>
                        </button>
                        <textarea id="onboardingInput" rows="2" style="flex: 1; border-radius: 8px; border: 1px solid var(--border); padding: 12px 16px; font-size: 14px; outline: none; resize: vertical; min-height: 44px; font-family: inherit;" placeholder="Tell me about your teaching goals..."></textarea>
                        <button id="onboardingSendBtn" style="flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; background: #3b82f6; color: white; padding: 12px 24px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            Send
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Research Panel (Right Side) - Always Visible -->
            <div id="researchPanel" style="flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; border-left: 1px solid var(--border); background: var(--bg);">
                <!-- Empty State -->
                <div id="researchEmptyState" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 40px;">
                    <div style="font-size: 64px; margin-bottom: 16px;">💡</div>
                    <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 8px 0; color: var(--text);">No Plan Yet</h2>
                    <p style="font-size: 14px; color: var(--muted); max-width: 300px;">Start chatting on the left to create your personalized teaching plan!</p>
                </div>
                
                <!-- Content State (hidden by default) -->
                <div id="researchContent" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                    <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 24px 32px; margin-bottom: 16px;">
                        <h1 style="font-size: 24px; font-weight: 700; margin: 0 0 8px 0;">📊 Your Teaching Plan</h1>
                        <p id="researchCreatedDate" style="font-size: 12px; color: var(--muted); margin: 0;"></p>
                    </div>
                    
                    <!-- Goal Section -->
                    <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 16px;">
                        <h2 style="font-size: 16px; font-weight: 600; margin: 0 0 4px 0;">🎯 Your Teaching Goal</h2>
                        <p style="font-size: 13px; color: var(--muted); margin: 0 0 12px 0;">Includes your responses and the clarifying questions asked</p>
                        <textarea id="goalTextArea" style="width: 100%; min-height: 150px; border-radius: 8px; border: 1px solid var(--border); padding: 12px; font-size: 14px; line-height: 1.6; resize: vertical; font-family: inherit;" placeholder="Your teaching goals will appear here..."></textarea>
                    </div>
                    
                    <!-- Research Results Section -->
                    <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 16px; flex: 1; display: flex; flex-direction: column;">
                        <h2 style="font-size: 16px; font-weight: 600; margin: 0 0 12px 0;">🔍 Research Results</h2>
                        <div id="researchOutputArea" style="flex: 1; overflow-y: auto; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; font-size: 14px; line-height: 1.7; color: var(--text);">
                            <p style="color: var(--muted);">Research results will appear here...</p>
                        </div>
                    </div>
                    
                <!-- Resources Section -->
                <div id="resourcesSection" style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 16px;">
                    <h2 style="font-size: 16px; font-weight: 600; margin: 0 0 12px 0;">📎 Resources</h2>
                    <div id="resourcesEmptyState" style="padding: 14px; background: var(--bg); border: 1px dashed var(--border); border-radius: 8px; color: var(--muted);">
                        Resources will appear here when your research is complete.
                    </div>
                    <div id="resourcesList" style="display: none; flex-direction: column; gap: 8px;"></div>
                </div>
                    
                    <!-- Save Button -->
                    <div style="display: flex; justify-content: flex-end; gap: 12px;">
                        <button id="saveResearchBtn" style="display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; background: #10b981; color: white; padding: 12px 24px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            💾 Save Goal Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Progress Mode View -->
        <div id="progressView" class="hidden" style="flex: 1; padding: 40px; overflow-y: auto; background: var(--bg);">
            <div style="max-width: 1200px; margin: 0 auto;">
                <div style="margin-bottom: 24px;">
                    <h1 style="font-size: 32px; font-weight: 700; margin: 0 0 8px 0;">Your Teaching Progress</h1>
                    <p style="font-size: 16px; color: var(--muted); margin: 0;">Track your growth over time with AI-powered insights</p>
                </div>
                
                <!-- Progress Filters -->
                <div style="background: white; border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Filter Your Progress</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; align-items: end;">
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px;">Class</label>
                            <select id="progressClassFilter" disabled style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: #f8fafc; color: var(--muted); cursor: not-allowed;">
                                <option>All Classes (Coming Soon)</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 6px;">From Date</label>
                            <input type="date" id="progressFromDate" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 6px;">To Date</label>
                            <input type="date" id="progressToDate" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <button id="applyProgressFilters" style="padding: 8px 20px; border: none; border-radius: 6px; background: var(--accent); color: white; font-weight: 600; cursor: pointer; white-space: nowrap;">Apply Filters</button>
                        </div>
                    </div>
                </div>
                
                <div id="progressContent">
                    <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
                        <div style="font-size: 18px;">Loading your progress...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Record Mode View -->
        <div id="recordView" class="hidden" style="flex: 1; display: flex; flex-direction: column; background: var(--bg); padding: 20px; overflow-y: auto;">
            <div style="max-width: 700px; width: 100%; margin: 0 auto; text-align: center;">
                <!-- Header -->
                <div style="margin-bottom: 24px;">
                    <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 8px 0;">Record a Lesson</h1>
                    <p style="font-size: 14px; color: var(--muted); margin: 0;">Audio will be automatically transcribed in real-time</p>
                </div>
                
                <!-- Duration Selector -->
                <div id="durationSelectorContainer" style="margin-bottom: 24px;">
                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 8px;">Duration</label>
                    <select id="recordDurationSelect" style="width: 100%; max-width: 250px; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; font-weight: 600; background: white; cursor: pointer; margin: 0 auto; display: block;">
                        <option value="900">15 minutes</option>
                        <option value="1800">30 minutes</option>
                        <option value="2700">45 minutes</option>
                        <option value="3600" selected>1 hour</option>
                        <option value="5400">1.5 hours</option>
                        <option value="7200">2 hours</option>
                    </select>
                </div>
                
                <!-- Record Button (toggles between record and stop) -->
                <div style="margin-bottom: 20px;">
                    <button id="recordButton" style="width: 160px; height: 160px; border: none; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-size: 18px; font-weight: 700; cursor: pointer; box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; margin: 0 auto;">
                        <svg id="recordIcon" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <line x1="12" x2="12" y1="19" y2="22"/>
                        </svg>
                        <span id="recordButtonText">RECORD</span>
                    </button>
                </div>
                
                <!-- Timer Display -->
                <div id="timerDisplay" style="font-size: 32px; font-weight: 700; font-variant-numeric: tabular-nums; letter-spacing: 1px; color: var(--text); margin-bottom: 20px; opacity: 0; transition: opacity 0.3s;">
                    <span id="timerText">00:00</span>
                    <span style="font-size: 16px; color: var(--muted);"> / </span>
                    <span id="maxDurationText" style="font-size: 16px; color: var(--muted);">01:00:00</span>
                </div>
                
                <!-- Status Indicators -->
                <div id="recordingStatus" style="background: white; border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 16px; opacity: 0; transition: opacity 0.3s;">
                    <div style="display: flex; flex-direction: column; gap: 10px; align-items: flex-start; text-align: left;">
                        <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                            <svg id="micStatusIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span style="font-size: 13px; font-weight: 600;">Microphone active</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                            <svg id="saveStatusIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span style="font-size: 13px; font-weight: 600;" id="saveStatusText">Auto-saving every 5 minutes</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                            <svg id="uploadStatusIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span style="font-size: 13px; font-weight: 600;" id="uploadStatusText">Transcribing in real-time</span>
                        </div>
                    </div>
                </div>
                
                <!-- Warnings -->
                <div id="recordingWarnings" style="display: flex; flex-direction: column; gap: 12px; opacity: 0; transition: opacity 0.3s; margin-bottom: 16px;">
                    <div style="display: flex; align-items: start; gap: 8px; padding: 10px; background: #fffbeb; border: 1px solid #fef3c7; border-radius: 8px; text-align: left;">
                        <span style="font-size: 16px;">⚠️</span>
                        <span style="font-size: 12px; color: #92400e;">Keep this tab open during recording</span>
                    </div>
                </div>
                
                <!-- Transcript Display (hidden by default) -->
                <div id="transcriptDisplay" class="hidden" style="margin-top: 16px; padding: 16px; background: white; border: 1px solid var(--border); border-radius: 10px; text-align: left;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; color: #1f2937;">📝 Live Transcript</div>
                    <div id="transcriptText" style="font-size: 13px; line-height: 1.6; color: #4b5563; max-height: 300px; overflow-y: auto; padding: 12px; background: #f9fafb; border-radius: 8px; white-space: pre-wrap;">
                        Waiting for transcription...
                    </div>
                </div>
                
                <!-- Processing Indicator -->
                <div id="processingIndicator" class="hidden" style="margin-top: 16px; padding: 16px; background: white; border: 1px solid var(--border); border-radius: 10px;">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Processing your recording...</div>
                    <div style="font-size: 13px; color: var(--muted);">This may take a few moments</div>
                </div>
                
                <!-- Complete State -->
                <div id="recordingComplete" class="hidden" style="margin-top: 16px; padding: 20px; background: white; border: 1px solid var(--border); border-radius: 10px;">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 10px; color: #10b981;">✓ Recording Complete!</div>
                    <div style="font-size: 13px; color: var(--muted); margin-bottom: 16px;" id="recordingName">Lesson_20251019_143012</div>
                    
                    <!-- Local save status and playback -->
                    <div id="localSaveContainer" style="margin-bottom: 16px; padding: 14px; background: #f9fafb; border-radius: 8px; text-align: left;">
                        <div id="localSaveStatus" style="font-size: 13px; color: #4b5563; margin-bottom: 8px;">Saving a copy to your device…</div>
                        <audio id="localPlaybackAudio" controls style="width:100%; display:none;"></audio>
                    </div>

                    <!-- Saved recordings loader -->
                    <div id="recordingsLoader" style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
                        <label for="recordingsDropdown" style="font-size: 13px; color: #374151;">Load a previous recording:</label>
                        <select id="recordingsDropdown" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: white; font-size: 13px;"></select>
                    </div>
                    
                    <!-- Final Transcript in Complete State -->
                    <div id="finalTranscriptBox" style="margin-bottom: 16px; padding: 14px; background: #f9fafb; border-radius: 8px; text-align: left; max-height: 300px; overflow-y: auto;">
                        <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #1f2937;">Full Transcript:</div>
                        <div id="finalTranscriptText" style="font-size: 13px; line-height: 1.6; color: #4b5563; white-space: pre-wrap;">
                            No transcript available
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button id="downloadRecordingBtn" style="padding: 10px 20px; border: 1px solid var(--border); border-radius: 8px; background: white; font-size: 13px; font-weight: 600; cursor: pointer;">
                            Download Audio
                        </button>
                        <button id="newRecordingBtn" style="padding: 10px 20px; border: none; border-radius: 8px; background: var(--accent); color: white; font-size: 13px; font-weight: 600; cursor: pointer;">
                            Record Another Lesson
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stop Recording Confirmation Modal -->
        <div id="stopRecordingModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
            <div style="background: white; border-radius: 16px; padding: 32px; max-width: 480px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Stop Recording?</div>
                    <div style="font-size: 15px; color: var(--muted); line-height: 1.6;">
                        Are you sure you want to stop the recording? Your audio will be saved and transcribed.
                    </div>
                </div>
                
                <!-- Recording Duration Info -->
                <div style="background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span style="font-size: 14px; color: var(--muted);">Recorded Duration:</span>
                        <span id="modalRecordedDuration" style="font-size: 18px; font-weight: 700; color: var(--text);">--:--</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button id="cancelStopRecording" style="padding: 12px 24px; border: 1px solid var(--border); border-radius: 8px; background: white; color: var(--text); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        Continue Recording
                    </button>
                    <button id="confirmStopRecording" style="padding: 12px 24px; border: none; border-radius: 8px; background: #ef4444; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        Stop & Save
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Lesson Analysis Mode View -->
        <div class="left" id="leftPanel">
            <div class="player-wrap">
                <div id="player"></div>
            </div>
        </div>
        <div class="divider" id="divider" title="Drag to resize"></div>
        <div class="right">
            <div class="right-header">
                <div class="tab active" data-tab="timestamps">Timestamps</div>
                <div class="tab" data-tab="chat">Assistant</div>
                <div class="tab" data-tab="flagged">Flagged</div>
                <div class="tab" data-tab="pedagogy">Pedagogy</div>
            </div>
            <div class="right-content" id="timestampsContent">
                <div id="timestamps" style="padding: 16px; overflow-y: auto; flex: 1;"></div>
            </div>
            <div class="right-content hidden" id="flaggedContent">
                <div id="flaggedList" style="padding: 16px; overflow-y: auto; flex: 1;"></div>
            </div>
            <div class="right-content hidden" id="chatContent">
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-area">
                    <div class="flex items-center gap-2">
                        <button id="micBtn" class="shrink-0 inline-flex items-center justify-center w-10 h-10 rounded-full bg-sky-500 text-white hover:brightness-110 transition" title="Tap to record / stop" aria-label="Record">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v3m0 0h-3m3 0h3M8.25 9v3a3.75 3.75 0 007.5 0V9m-7.5 0A3.75 3.75 0 0112 5.25v0A3.75 3.75 0 0115.75 9v3A3.75 3.75 0 0112 15.75v0A3.75 3.75 0 018.25 12V9z" />
                            </svg>
                        </button>
                        <textarea id="chatInput" rows="2" class="flex-1 rounded-lg border border-[var(--border)] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-400 resize-vertical" style="min-height: 44px; font-family: inherit;" placeholder="Ask about this lesson..."></textarea>
                        <button id="sendBtn" class="shrink-0 inline-flex items-center justify-center rounded-lg bg-sky-600 text-white px-4 py-2 hover:brightness-110 transition">Send</button>
                    </div>
                </div>
            </div>
            <div class="right-content hidden" id="pedagogyContent">
                <div style="padding: 12px 16px; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h3 style="margin: 0 0 4px 0; font-size: 14px; font-weight: 600; color: var(--text);">Pedagogy Analysis</h3>
                            <p style="margin: 0; font-size: 12px; color: var(--muted);">Customize which sections appear in your dashboard</p>
                        </div>
                        <button id="pedagogySettingsBtn" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; background: white; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px; flex-shrink: 0;">
                            <span>⚙</span> Settings
                        </button>
                    </div>
                </div>
                <div id="pedagogyView" style="padding: 16px; overflow-y: auto; flex: 1;"></div>
            </div>
        </div>
    </div>
    
    <!-- Pedagogy Settings Modal -->
    <div id="pedagogySettingsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 20px; font-weight: 700;">Customize Dashboard</h2>
                <button id="closeSettingsModal" style="border: none; background: none; font-size: 24px; cursor: pointer; color: var(--muted); line-height: 1;">&times;</button>
            </div>
            <p style="color: var(--muted); font-size: 14px; margin: 0 0 20px 0;">Choose which sections to display in your Pedagogy dashboard</p>
            
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px; border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s;">
                    <input type="checkbox" id="setting_teachingSummary" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Teaching Summary</div>
                        <div style="font-size: 12px; color: var(--muted);">AI-generated overview of teaching approach</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px; border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s;">
                    <input type="checkbox" id="setting_teacherStudentTalk" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Teacher vs Student Talk</div>
                        <div style="font-size: 12px; color: var(--muted);">Timeline visualization of speaking patterns</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px; border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s;">
                    <input type="checkbox" id="setting_waitTime" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Wait Time Analysis</div>
                        <div style="font-size: 12px; color: var(--muted);">Statistics and histogram of pause times</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px; border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s;">
                    <input type="checkbox" id="setting_questionTypes" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Question Types</div>
                        <div style="font-size: 12px; color: var(--muted);">Breakdown of questioning strategies</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px; border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s;">
                    <input type="checkbox" id="setting_pedagogies" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Pedagogies Identified</div>
                        <div style="font-size: 12px; color: var(--muted);">Teaching strategies observed in lesson</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px; border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s;">
                    <input type="checkbox" id="setting_keyStrategies" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Key Teaching Strategies</div>
                        <div style="font-size: 12px; color: var(--muted);">Bullet-point summary of key strategies</div>
                    </div>
                </label>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
                <button id="cancelSettings" style="padding: 10px 20px; border: 1px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-weight: 600;">Cancel</button>
                <button id="saveSettings" style="padding: 10px 20px; border: none; border-radius: 8px; background: var(--accent); color: white; cursor: pointer; font-weight: 600;">Save Preferences</button>
            </div>
        </div>
    </div>
</div>
    <script>
    var embedApi; var isPlayerReady = false; var queuedSeekSeconds = null; var currentMeta = null; var metadataList = []; var currentTranscriptRaw = null;
    var panoptoApiReady = false; var pendingInitSessionId = null; var currentPlayerSessionId = null;
    var flaggedTimestamps = new Set(); var allFlags = [];
    var currentMode = 'lesson_analysis'; // Default mode
    var onboardingConversation = []; // Store conversation history
    var onboardingRecorder = null; // Voice recorder for onboarding

    window.onPanoptoEmbedApiReady = function(){
        panoptoApiReady = true;
        if (pendingInitSessionId) {
            const sid = pendingInitSessionId; pendingInitSessionId = null;
            actuallyCreatePlayer(sid);
        }
    };

    function getQueryParam(name) { const url = new URL(window.location.href); return url.searchParams.get(name); }
    
    // Mode switching
    function switchMode(mode) {
        // Pause video when switching away from lesson_analysis mode
        if (currentMode === 'lesson_analysis' && mode !== 'lesson_analysis') {
            if (embedApi && isPlayerReady) {
                try {
                    embedApi.pause();
                    console.log('🎬 Video paused when switching to:', mode);
                } catch (error) {
                    console.error('Error pausing video:', error);
                }
            }
        }
        
        currentMode = mode;
        const url = new URL(window.location.href);
        url.searchParams.set('mode', mode);
        history.replaceState({}, '', url);
        
        // Update UI
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        
        const leftPanel = document.getElementById('leftPanel');
        const divider = document.getElementById('divider');
        const rightPanel = document.querySelector('.right');
        const onboardingView = document.getElementById('onboardingView');
        const progressView = document.getElementById('progressView');
        const recordView = document.getElementById('recordView');
        const lessonSelector = document.getElementById('lessonSelector');
        const recordActions = document.getElementById('recordActions');
        
        if (mode === 'onboarding') {
            // Show onboarding, hide others
            onboardingView.classList.remove('hidden');
            progressView.classList.add('hidden');
            recordView.classList.add('hidden');
            leftPanel.classList.add('hidden');
            divider.classList.add('hidden');
            rightPanel.classList.add('hidden');
            lessonSelector.classList.add('hidden');
            if (recordActions) recordActions.classList.add('hidden');
            // Initialize onboarding chat
            initializeOnboardingChat();
        } else if (mode === 'progress') {
            // Show progress, hide others
            onboardingView.classList.add('hidden');
            progressView.classList.remove('hidden');
            recordView.classList.add('hidden');
            leftPanel.classList.add('hidden');
            divider.classList.add('hidden');
            rightPanel.classList.add('hidden');
            lessonSelector.classList.add('hidden');
            if (recordActions) recordActions.classList.add('hidden');
            // Load progress data
            loadProgressView();
        } else if (mode === 'record') {
            // Show record, hide others
            onboardingView.classList.add('hidden');
            progressView.classList.add('hidden');
            recordView.classList.remove('hidden');
            leftPanel.classList.add('hidden');
            divider.classList.add('hidden');
            rightPanel.classList.add('hidden');
            lessonSelector.classList.add('hidden');
            if (recordActions) recordActions.classList.remove('hidden');
            // Initialize recording view
            initializeRecordView();
        } else {
            // Show lesson analysis, hide others
            onboardingView.classList.add('hidden');
            progressView.classList.add('hidden');
            recordView.classList.add('hidden');
            leftPanel.classList.remove('hidden');
            divider.classList.remove('hidden');
            rightPanel.classList.remove('hidden');
            lessonSelector.classList.remove('hidden');
            if (recordActions) recordActions.classList.add('hidden');
        }
    }
    
    // Initialize mode from URL
    function initializeMode() {
        const modeParam = getQueryParam('mode');
        if (modeParam === 'onboarding') {
            switchMode('onboarding');
        } else {
            switchMode('lesson_analysis');
        }
    }
    
    // ========== ONBOARDING CHAT FUNCTIONS ==========
    
    // Format text with markdown-like syntax to HTML
    function formatMessageText(text) {
        if (!text) return '';
        
        // Convert **bold** to <strong>
        text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        
        // Convert numbered lists (1. 2. 3.) to proper formatting with line breaks
        text = text.replace(/(\d+)\.\s\*\*/g, '<br><br><strong>$1.</strong> <strong>');
        text = text.replace(/(\d+)\.\s/g, '<br><br><strong>$1.</strong> ');
        
        // Convert bullet points (- ) to proper formatting
        text = text.replace(/^-\s/gm, '<br>• ');
        
        // Clean up multiple br tags at start
        text = text.replace(/^(<br>)+/, '');
        
        return text;
    }
    
    // Enhanced formatter for research output with full markdown support
    function formatResearchOutput(text) {
        if (!text) return '<p style="color: var(--muted);">No research available yet.</p>';
        
        let html = '';
        const lines = text.split('\n');
        let inList = false;
        let inNumberedList = false;
        let currentParagraph = '';
        
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            
            // Skip empty lines but close lists if needed
            if (!line) {
                if (inList) {
                    html += '</ul>';
                    inList = false;
                }
                if (inNumberedList) {
                    html += '</ol>';
                    inNumberedList = false;
                }
                if (currentParagraph) {
                    html += `<p style="margin: 12px 0; line-height: 1.7;">${currentParagraph}</p>`;
                    currentParagraph = '';
                }
                continue;
            }
            
            // Handle headers
            if (line.startsWith('###')) {
                if (inList) { html += '</ul>'; inList = false; }
                if (inNumberedList) { html += '</ol>'; inNumberedList = false; }
                if (currentParagraph) { html += `<p style="margin: 12px 0; line-height: 1.7;">${currentParagraph}</p>`; currentParagraph = ''; }
                const headerText = line.replace(/^###\s*/, '');
                html += `<h3 style="font-size: 16px; font-weight: 600; margin: 24px 0 12px 0; color: var(--text);">${headerText}</h3>`;
            } else if (line.startsWith('##')) {
                if (inList) { html += '</ul>'; inList = false; }
                if (inNumberedList) { html += '</ol>'; inNumberedList = false; }
                if (currentParagraph) { html += `<p style="margin: 12px 0; line-height: 1.7;">${currentParagraph}</p>`; currentParagraph = ''; }
                const headerText = line.replace(/^##\s*/, '');
                html += `<h2 style="font-size: 18px; font-weight: 600; margin: 20px 0 12px 0; color: var(--text);">${headerText}</h2>`;
            }
            // Handle bullet points
            else if (line.startsWith('-') || line.startsWith('•')) {
                if (inNumberedList) { html += '</ol>'; inNumberedList = false; }
                if (currentParagraph) { html += `<p style="margin: 12px 0; line-height: 1.7;">${currentParagraph}</p>`; currentParagraph = ''; }
                if (!inList) {
                    html += '<ul style="margin: 12px 0 12px 20px; padding-left: 20px;">';
                    inList = true;
                }
                const listText = line.replace(/^[-•]\s*/, '').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                html += `<li style="margin: 8px 0; line-height: 1.7;">${listText}</li>`;
            }
            // Handle numbered lists
            else if (/^\d+\.\s/.test(line)) {
                if (inList) { html += '</ul>'; inList = false; }
                if (currentParagraph) { html += `<p style="margin: 12px 0; line-height: 1.7;">${currentParagraph}</p>`; currentParagraph = ''; }
                if (!inNumberedList) {
                    html += '<ol style="margin: 12px 0 12px 20px; padding-left: 20px;">';
                    inNumberedList = true;
                }
                const listText = line.replace(/^\d+\.\s*/, '').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                html += `<li style="margin: 8px 0; line-height: 1.7;">${listText}</li>`;
            }
            // Regular paragraphs
            else {
                if (inList) { html += '</ul>'; inList = false; }
                if (inNumberedList) { html += '</ol>'; inNumberedList = false; }
                
                // Apply bold formatting
                const formattedLine = line.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                
                if (currentParagraph) {
                    currentParagraph += ' ' + formattedLine;
                } else {
                    currentParagraph = formattedLine;
                }
            }
        }
        
        // Close any open tags
        if (inList) html += '</ul>';
        if (inNumberedList) html += '</ol>';
        if (currentParagraph) html += `<p style="margin: 12px 0; line-height: 1.7;">${currentParagraph}</p>`;
        
        return html;
    }
    
    function addOnboardingMessage(role, text) {
        const messagesContainer = document.getElementById('onboardingMessages');
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = 'display: flex; align-items: flex-start; gap: 12px;' + (role === 'user' ? 'justify-content: flex-end;' : '');
        
        const bubble = document.createElement('div');
        bubble.style.cssText = 'max-width: 75%; padding: 14px 18px; border-radius: 16px; line-height: 1.7; word-wrap: break-word;';
        
        if (role === 'user') {
            bubble.style.cssText += 'background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-bottom-right-radius: 4px;';
        } else {
            bubble.style.cssText += 'background: #f8fafc; color: #1e293b; border: 1px solid #e2e8f0; border-bottom-left-radius: 4px;';
        }
        
        // Use innerHTML for formatted text
        bubble.innerHTML = formatMessageText(text || '');
        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        return bubble;
    }
    
    async function sendOnboardingMessage() {
        const input = document.getElementById('onboardingInput');
        const userText = input.value.trim();
        if (!userText) return;
        
        // Add user message to UI
        addOnboardingMessage('user', userText);
        input.value = '';
        
        // Add to conversation history
        onboardingConversation.push({ role: 'user', content: userText });
        
        // Show animated thinking indicator
        const thinkingBubble = addOnboardingMessage('assistant', 'Thinking.');
        let thinkingDots = 1;
        const thinkingInterval = setInterval(() => {
            thinkingDots = (thinkingDots % 3) + 1;
            thinkingBubble.innerHTML = 'Thinking' + '.'.repeat(thinkingDots);
        }, 500);
        
        try {
            // Send to backend with conversation history
            const response = await fetch('/api/onboarding/chat/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    conversation: onboardingConversation 
                })
            });
            
            if (!response.ok) throw new Error('Failed to get response');
            
            // Stop thinking animation
            clearInterval(thinkingInterval);
            
            // Handle streaming response
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = '';
            let shouldTriggerResearch = false;
            let researchQuery = '';
            
            // Remove thinking bubble and create response bubble
            thinkingBubble.parentElement.remove();
            const responseBubble = addOnboardingMessage('assistant', '');
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (data === '[DONE]') continue;
                        
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed.content) {
                                fullResponse += parsed.content;
                                responseBubble.innerHTML = formatMessageText(fullResponse);
                            }
                            if (parsed.triggerResearch !== undefined) {
                                shouldTriggerResearch = parsed.triggerResearch;
                                researchQuery = parsed.researchQuery || '';
                            }
                        } catch (e) {
                            // Skip invalid JSON
                        }
                    }
                }
            }
            
            // Add to conversation history
            onboardingConversation.push({ role: 'assistant', content: fullResponse });
            
            // Check if we should trigger Manus research
            if (shouldTriggerResearch) {
                console.log('🚀 Triggering Manus research...');
                // Trigger Manus research and then show research panel
                await triggerManusResearch(researchQuery);
                
                // After 2 seconds, load the research panel and disable chat
                setTimeout(() => {
                    loadResearchPanel();
                    disableChatWithStatus('researching');
                }, 2000);
            }
            
        } catch (error) {
            console.error('Onboarding chat error:', error);
            clearInterval(thinkingInterval);
            thinkingBubble.innerHTML = 'Sorry, I encountered an error. Please try again.';
        }
    }
    
    async function triggerManusResearch(query) {
        try {
            const response = await fetch('/api/onboarding/trigger-manus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    query: query,
                    conversation: onboardingConversation 
                })
            });
            
            if (!response.ok) throw new Error('Failed to trigger Manus');
            
            const data = await response.json();
            console.log('✅ Manus research triggered:', data);
            console.log('📊 Task URL:', data.manusTaskUrl);
            console.log('🔗 Share URL:', data.manusShareUrl);
            // Prefer Supabase session status over local flag; fallback to local only if save not returned
            if (data.savedSession && data.savedSession.id) {
                window.currentSessionId = data.savedSession.id;
            } else {
                try { localStorage.setItem('onboarding_research_status', 'researching'); } catch (e) {}
            }

            // Immediately clear any stale resources in the UI
            try {
                const resourcesList = document.getElementById('resourcesList');
                const resourcesEmpty = document.getElementById('resourcesEmptyState');
                if (resourcesList) {
                    resourcesList.innerHTML = '';
                    resourcesList.style.display = 'none';
                }
                if (resourcesEmpty) resourcesEmpty.style.display = 'block';
            } catch (e) {}
            
            // Add styled confirmation message (no links in UI)
            const messagesContainer = document.getElementById('onboardingMessages');
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'display: flex; justify-content: flex-start;';
            
            const bubble = document.createElement('div');
            bubble.style.cssText = 'max-width: 70%; padding: 12px 16px; border-radius: 12px; background: #f0f9ff; color: #0c4a6e; border: 1px solid #bae6fd; border-bottom-left-radius: 4px;';
            
            bubble.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <strong style="font-size: 15px;">Research Started!</strong>
                </div>
                <div style="margin-bottom: 12px; color: #0c4a6e;">
                    Your personalized teaching research is now underway with Manus AI.
                </div>
                <div style="padding-top: 12px; border-top: 1px solid #bae6fd; font-size: 13px; color: #0c4a6e;">
                    You'll receive an email when the analysis is complete. Results will appear in the panel on the right.
                </div>
            `;
            
            messageDiv.appendChild(bubble);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
        } catch (error) {
            console.error('Manus trigger error:', error);
            addOnboardingMessage('assistant', '❌ Sorry, there was an error creating the research task. Please try again or contact support.');
        }
    }
    
    // Voice input for onboarding
    async function toggleOnboardingMic() {
        const btn = document.getElementById('onboardingMicBtn');
        
        if (onboardingRecorder && onboardingRecorder.state === 'recording') {
            // Stop recording
            onboardingRecorder.stop();
            btn.style.background = '#3b82f6';
        } else {
            // Start recording
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                onboardingRecorder = new MediaRecorder(stream);
                const chunks = [];
                
                onboardingRecorder.ondataavailable = e => {
                    if (e.data && e.data.size > 0) chunks.push(e.data);
                };
                
                onboardingRecorder.onstop = async () => {
                    stream.getTracks().forEach(t => t.stop());
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    const arrayBuffer = await blob.arrayBuffer();
                    
                    try {
                        const response = await fetch('/api/realtime/transcribe', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/octet-stream' },
                            body: arrayBuffer
                        });
                        
                        if (!response.ok) throw new Error('Transcription failed');
                        
                        const data = await response.json();
                        const text = data.text || '';
                        document.getElementById('onboardingInput').value = text;
                    } catch (e) {
                        console.error('Transcription error:', e);
                    }
                };
                
                onboardingRecorder.start();
                btn.style.background = '#ef4444';
            } catch (e) {
                console.error('Microphone error:', e);
                alert('Could not access microphone');
            }
        }
    }
    
    // Initialize onboarding chat with welcome message
    async function initializeOnboardingChat() {
        const messagesContainer = document.getElementById('onboardingMessages');
        
        // Check if user has existing session
        try {
            const response = await fetch('/api/onboarding/session/kwen1510@hotmail.com');
            if (response.ok) {
                const session = await response.json();
                const localStatus = (function(){ try { return localStorage.getItem('onboarding_research_status'); } catch(e) { return null; } })();
                
                if (session && (session.status === 'completed' || session.status === 'researching' || localStatus === 'researching')) {
                    // Load the research panel
                    console.log('✅ Found existing session, loading research panel...');
                    loadResearchPanel();
                    
                    // Disable chat and show status
                    disableChatWithStatus(localStatus === 'researching' ? 'researching' : (session.status === 'completed' ? 'completed' : 'researching'));
                    return;
                }
            }
        } catch (error) {
            console.error('Error checking for existing session:', error);
        }
        
        // No existing session, show welcome message
        if (messagesContainer.children.length === 0) {
            addOnboardingMessage('assistant', 'Hello! I\'m here to help you set up your lesson analysis. What are your main teaching goals or areas you\'d like to improve?');
        }
    }
    
    // Disable chat and show status message with restart button
    function disableChatWithStatus(status) {
        const messagesContainer = document.getElementById('onboardingMessages');
        messagesContainer.innerHTML = ''; // Clear messages
        
        const statusDiv = document.createElement('div');
        statusDiv.style.cssText = 'display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 40px;';
        
        if (status === 'completed') {
            statusDiv.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 16px;">✓</div>
                <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 12px 0; color: var(--text);">Research Complete</h2>
                <p style="font-size: 14px; color: var(--muted); margin-bottom: 24px; max-width: 400px;">
                    Your teaching research is available in the panel on the right. You can edit and save your goals and research anytime.
                </p>
                <button id="restartGoalsBtn" style="display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; background: #3b82f6; color: white; padding: 12px 24px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Start New Research
                </button>
            `;
        } else {
            statusDiv.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 16px;">⏳</div>
                <h2 style="font-size: 20px; font-weight: 600; margin: 0 0 12px 0; color: var(--text);">Research In Progress</h2>
                <p style="font-size: 14px; color: var(--muted); margin-bottom: 24px; max-width: 400px;">
                    Your research is underway. You'll receive an email when it's complete, and results will appear in the panel on the right.
                </p>
                <button id="restartGoalsBtn" style="display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; background: #3b82f6; color: white; padding: 12px 24px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Start New Research
                </button>
            `;
        }
        
        messagesContainer.appendChild(statusDiv);
        
        // Disable input
        const input = document.getElementById('onboardingInput');
        const sendBtn = document.getElementById('onboardingSendBtn');
        const micBtn = document.getElementById('onboardingMicBtn');
        
        input.disabled = true;
        input.placeholder = 'Research in progress...';
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.5';
        sendBtn.style.cursor = 'not-allowed';
        micBtn.disabled = true;
        micBtn.style.opacity = '0.5';
        micBtn.style.cursor = 'not-allowed';
        
        // Add restart button listener
        setTimeout(() => {
            const restartBtn = document.getElementById('restartGoalsBtn');
            if (restartBtn) {
                restartBtn.addEventListener('click', restartGoals);
            }
        }, 100);
    }
    
    // Restart goals - clear session and refresh
    async function restartGoals() {
        if (!confirm('Are you sure you want to start a new research? Your current research will remain saved but you\'ll create a new one.')) {
            return;
        }
        
        // Clear the conversation
        onboardingConversation = [];
        
        // Enable chat
        const input = document.getElementById('onboardingInput');
        const sendBtn = document.getElementById('onboardingSendBtn');
        const micBtn = document.getElementById('onboardingMicBtn');
        const messagesContainer = document.getElementById('onboardingMessages');
        
        input.disabled = false;
        input.placeholder = 'Tell me about your teaching goals...';
        sendBtn.disabled = false;
        sendBtn.style.opacity = '1';
        sendBtn.style.cursor = 'pointer';
        micBtn.disabled = false;
        micBtn.style.opacity = '1';
        micBtn.style.cursor = 'pointer';
        
        // Clear messages and show welcome
        messagesContainer.innerHTML = '';
        addOnboardingMessage('assistant', 'Hello! I\'m here to help you set up your lesson analysis. What are your main teaching goals or areas you\'d like to improve?');
        
        // Hide research panel and show empty state
        document.getElementById('researchEmptyState').style.display = 'flex';
        document.getElementById('researchContent').classList.add('hidden');
    }
    
    // Load research panel with data from Supabase
    async function loadResearchPanel() {
        try {
            console.log('📊 Loading research panel...');
            
            // Fetch the latest session
            const response = await fetch('/api/onboarding/session/kwen1510@hotmail.com');
            if (!response.ok) throw new Error('Failed to load session');
            
            const session = await response.json();
            if (!session) {
                console.warn('No session found');
                return;
            }
            
            // Store session ID for saving
            window.currentSessionId = session.id;
            
            // Show research content, hide empty state
            document.getElementById('researchEmptyState').style.display = 'none';
            document.getElementById('researchContent').classList.remove('hidden');
            
            // Populate the fields
            document.getElementById('goalTextArea').value = session.goal_text || '';
            
            // Format and display research output
            // When a new research task is in progress, do NOT show any previous
            // research_output. Always show an in-progress placeholder instead.
            const forceResearching = (function(){ try { return localStorage.getItem('onboarding_research_status') === 'researching'; } catch(e) { return false; } })();
            const researchOutput = (session.status === 'researching' || forceResearching)
                ? 'Research in progress... You\'ll receive an email when complete.'
                : (session.research_output || 'No research results yet.');
            document.getElementById('researchOutputArea').innerHTML = formatResearchOutput(researchOutput);
            
            // Format date (DD/MM/YYYY)
            if (session.created_at) {
                const date = new Date(session.created_at);
                const formattedDate = date.toLocaleDateString('en-GB');
                document.getElementById('researchCreatedDate').textContent = `Created: ${formattedDate}`;
            }
            
            // Clear resources list first to remove any stale items
            const resourcesList = document.getElementById('resourcesList');
            const resourcesEmpty = document.getElementById('resourcesEmptyState');
            if (resourcesList) {
                resourcesList.innerHTML = '';
            }
            
            const isResearching = (session.status === 'researching' || forceResearching);
            if (resourcesEmpty) resourcesEmpty.style.display = isResearching ? 'block' : 'none';
            if (resourcesList) resourcesList.style.display = isResearching ? 'none' : 'flex';

            // Display resources only for completed research to avoid showing stale data
            if (!isResearching && session.status === 'completed' && session.research_sources && session.research_sources.length > 0) {
                
                session.research_sources.forEach((source, idx) => {
                    const resourceItem = document.createElement('div');
                    resourceItem.style.cssText = 'padding: 14px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s; cursor: pointer;';
                    
                    // Add hover effect
                    resourceItem.onmouseenter = function() {
                        this.style.borderColor = '#3b82f6';
                        this.style.boxShadow = '0 2px 8px rgba(59, 130, 246, 0.15)';
                    };
                    resourceItem.onmouseleave = function() {
                        this.style.borderColor = 'var(--border)';
                        this.style.boxShadow = 'none';
                    };
                    
                    if (source.file_name && source.url) {
                        resourceItem.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="flex-shrink: 0; width: 40px; height: 40px; background: #eff6ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                    📄
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${source.file_name}
                                    </div>
                                    <div style="font-size: 12px; color: var(--muted);">
                                        ${source.size_bytes ? `${(source.size_bytes / 1024).toFixed(1)} KB` : 'Document'}
                                    </div>
                                </div>
                                <div style="flex-shrink: 0;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </div>
                            </div>
                        `;
                        
                        // Make the whole card clickable
                        resourceItem.onclick = function() {
                            window.open(source.url, '_blank');
                        };
                    } else if (source.url) {
                        resourceItem.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="flex-shrink: 0; width: 40px; height: 40px; background: #eff6ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                    🔗
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 14px; font-weight: 500; color: #3b82f6; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${source.url}
                                    </div>
                                </div>
                                <div style="flex-shrink: 0;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </div>
                            </div>
                        `;
                        
                        resourceItem.onclick = function() {
                            window.open(source.url, '_blank');
                        };
                    }
                    
                    resourcesList.appendChild(resourceItem);
                });
            }
            
            // Clear local override once backend reports completion
            if (session.status === 'completed') { try { localStorage.removeItem('onboarding_research_status'); } catch(e) {} }

            // Start/stop polling until completion
            if (session.status === 'researching' || forceResearching) {
                if (!window.__researchPoller) {
                    window.__researchPoller = setInterval(async () => {
                        try {
                            const r = await fetch('/api/onboarding/session/kwen1510@hotmail.com');
                            if (r.ok) {
                                const s = await r.json();
                                if (s && s.status === 'completed') {
                                    clearInterval(window.__researchPoller);
                                    window.__researchPoller = null;
                                    try { localStorage.removeItem('onboarding_research_status'); } catch(e) {}
                                    loadResearchPanel();
                                }
                            }
                        } catch(e) { /* ignore transient errors */ }
                    }, 15000);
                }
            } else if (window.__researchPoller) {
                clearInterval(window.__researchPoller);
                window.__researchPoller = null;
            }
            console.log('✅ Research panel loaded');
            
        } catch (error) {
            console.error('Error loading research panel:', error);
        }
    }
    
    // Save research changes to Supabase
    async function saveResearchChanges() {
        if (!window.currentSessionId) {
            alert('No session to save');
            return;
        }
        
        try {
            console.log('💾 Saving changes...');
            
            const goalText = document.getElementById('goalTextArea').value;
            // Note: research output is read-only formatted content, only save goal_text
            
            const response = await fetch(`/api/onboarding/session/${window.currentSessionId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    goal_text: goalText
                })
            });
            
            if (!response.ok) throw new Error('Failed to save');
            
            console.log('✅ Changes saved');
            
            // Show success feedback
            const btn = document.getElementById('saveResearchBtn');
            const originalText = btn.textContent;
            btn.textContent = '✅ Saved!';
            btn.style.background = '#10b981';
            
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
            
        } catch (error) {
            console.error('Error saving changes:', error);
            alert('Failed to save changes. Please try again.');
        }
    }

    function initPlayer(sessionId) {
        if (!panoptoApiReady || typeof EmbedApi === 'undefined') {
            pendingInitSessionId = sessionId;
            return;
        }
        actuallyCreatePlayer(sessionId);
    }

    function actuallyCreatePlayer(sessionId){
        // Only recreate player if sessionId changed (prevents Panopto logout)
        if (currentPlayerSessionId === sessionId && embedApi) {
            console.log('Player already loaded for session:', sessionId);
            return; // Player already exists for this session
        }
        
        console.log('Creating new player for session:', sessionId);
        currentPlayerSessionId = sessionId;
        isPlayerReady = false; queuedSeekSeconds = null; document.getElementById('player').innerHTML = '';
            embedApi = new EmbedApi("player", {
            width: "100%", height: "100%", serverName: "ri.ap.panopto.com", sessionId: sessionId,
            videoParams: { interactivity: "none", showtitle: "false" },
            events: {
                onIframeReady: function(){ updateStatus("Splash ready. Click a timestamp to load & play."); },
                onReady: function(){ isPlayerReady = true; updateStatus("Ready. Choose a timestamp."); try { embedApi.setVolume(0.3); } catch(e){}
                    if (queuedSeekSeconds !== null) { var s = queuedSeekSeconds; queuedSeekSeconds = null; try{embedApi.pauseVideo();}catch(e){} embedApi.seekTo(s); embedApi.playVideo(); updateStatus('Jumped to ' + formatTime(s)); }
                },
                onStateChange: function(state){ if (state === PlayerState.Playing) updateStatus("Playing"); else if (state === PlayerState.Paused) updateStatus("Paused"); else if (state === PlayerState.Ended) updateStatus("Ended"); }
                }
            });
        }

    function updateStatus(m){ /* status hidden by design */ }
    function formatTime(total){ var t=Math.floor(Number(total)||0),h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=t%60; return (h>0?h+':':'')+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
    function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    function roleLabel(entry){ if (entry && entry.role) return entry.role.toUpperCase(); if (entry && entry.speaker && String(entry.speaker).toLowerCase().startsWith('speaker_0')) return 'TEACHER'; return 'STUDENT'; }
    function mapTimestamps(data){ var items=[]; function push(v,r){ var st=Number(v); if(isFinite(st)) items.push({start:st,speaker:(r&&r.speaker)||'',text:(r&&(r.text||r.label))||'',role:(r&&r.role)||''}); }
        function fromArray(arr){ arr.forEach(e=>{ if(typeof e==='number'||typeof e==='string') push(e); else if(e&&typeof e==='object'){ var c=e.start; if(c===undefined)c=e.time; if(c===undefined)c=e.timestamp; push(c,e);} }); }
        if(Array.isArray(data)) fromArray(data); else if(data&&typeof data==='object'){ if(Array.isArray(data.timestamps)) fromArray(data.timestamps); else if(Array.isArray(data.segments)) fromArray(data.segments);} return items; }

    window.seekTo = function(ts){ var s=ts; if(typeof ts==='object'&&ts) s=ts.start; s=Number(s); if(!isFinite(s)||s<0) return updateStatus('Invalid timestamp'); if(!isPlayerReady){ queuedSeekSeconds=s; try{ if(embedApi&&embedApi.loadVideo) embedApi.loadVideo(); }catch(e){} updateStatus('Loading... will jump to '+formatTime(s)); return; } try{embedApi.pauseVideo();}catch(e){} var d=Number(embedApi.getDuration&&embedApi.getDuration()); if(isFinite(d)&&s>d) s=Math.max(0,d-1); embedApi.seekTo(s); embedApi.playVideo(); updateStatus('Jumped to '+formatTime(s)); };

    function populateSelector(list){ 
        var sel=document.getElementById('videoSelect'); 
        var html=list.map(v=>{ var when=v.uploadedAtFormatted||v.uploadedAt||''; var label=escapeHtml(v.title)+' — '+escapeHtml(when); return '<option value="'+v.sessionId+'">'+label+'</option>'; }).join('');
        sel.innerHTML=html; 
    }
    function findByIdOrSession(list, ident){ for(var i=0;i<list.length;i++){ if(list[i].sessionId===ident) return list[i]; } return null; }

    async function loadLesson(meta){
        currentMeta = meta; initPlayer(meta.sessionId);
        await loadFlags(meta.sessionId);
        
        // Auto-reload pedagogy view if it's the active tab
        const pedagogyTab = document.querySelector('.tab[data-tab="pedagogy"]');
        if (pedagogyTab && pedagogyTab.classList.contains('active')) {
            loadPedagogyView(meta.sessionId);
        }
        fetch('/api/timestamps?sessionId='+encodeURIComponent(meta.sessionId)).then(r=>{ if(!r.ok) throw new Error('Cannot load transcript'); return r.json(); })
            .then(data=>{ currentTranscriptRaw = data; var list=mapTimestamps(data); var box=document.getElementById('timestamps'); if(!list.length){ box.innerHTML='<div class="meta">No timestamps found.</div>'; return; }
                box.innerHTML=list.map(function(it,idx){ 
                    var who=roleLabel(it); 
                    var snippet=(it.text?escapeHtml(String(it.text).slice(0,160)):''); 
                    var roleClass = (who==='TEACHER')? 'role-teacher' : 'role-student'; 
                    var isFlagged=flaggedTimestamps.has(it.start); 
                    var flagId='flag_'+idx+'_'+it.start;
                    return '<div class="time-item"><button class="seek-btn '+roleClass+'" onclick="window.seekTo('+it.start+')"><span class="time-chip">'+formatTime(it.start)+'</span><span class="time-body">'+(who?('<strong>'+who+': </strong>'):'')+snippet+'</span></button><div class="time-item-side"><button id="'+flagId+'" class="flag-btn '+(isFlagged?'flagged':'')+'" data-ts="'+it.start+'" data-speaker="'+escapeHtml(who)+'" data-role="'+escapeHtml(it.role||'')+'" title="'+(isFlagged?'Unflag this':'Flag this')+'">🚩</button></div></div>'; 
                }).join(''); 
                // Add event listeners to flag buttons
                document.querySelectorAll('.flag-btn').forEach(btn=>{
                    btn.addEventListener('click',function(e){
                        e.stopPropagation();
                        var ts=parseInt(this.dataset.ts);
                        var speaker=this.dataset.speaker;
                        var role=this.dataset.role;
                        var text=currentTranscriptRaw.find(t=>t.start===ts)?.text||'';
                        toggleFlag(ts,speaker,text,role,e);
                    });
                });
            })
            .catch(e=>{ document.getElementById('timestamps').innerHTML='<div class="meta">'+escapeHtml(e.message)+'</div>'; updateStatus(e.message); });
    }

    // Chat UI helpers
    function addMsg(role, text){ 
        var wrap = document.getElementById('chatMessages'); 
        var isUser = role === 'user'; 
        var message = document.createElement('div'); 
        message.className = 'chat-message ' + role; 
        var bubble = document.createElement('div'); 
        bubble.className = 'chat-bubble ' + role + (isUser ? '' : ' md'); 
        bubble.textContent = text || ''; 
        message.appendChild(bubble); 
        wrap.appendChild(message); 
        wrap.scrollTop = wrap.scrollHeight; 
        return bubble; 
    }

    // Minimal markdown renderer (bold, headings, lists) for assistant output
    function renderMarkdownLite(targetEl, raw){
        var text = String(raw || '');
        // Escape basic HTML
        text = text.replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
        // Headings: lines starting with **Answer:** etc stay bold
        text = text.replace(/^\*\*(.+?)\*\*:/gm, '<strong>$1:</strong>');
        // Bold/italic
        text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
        // Timestamp links like [mm:ss] or [hh:mm:ss]
        text = text.replace(/\[(\d{1,2}:)?\d{1,2}:\d{2}\]/g, function(m){
            var t = m.slice(1,-1); // drop [ ]
            return '<a href="#" class="ts-link" data-ts="'+t+'">['+t+']</a>';
        });
        // Bullet lines that start with - or •
        text = text.replace(/^[-•] (.*)$/gm, '<li>$1</li>');
        text = text.replace(/(<li>.*<\/li>\n?)+/g, m=>'<ul>'+m.replace(/\n/g,'')+'</ul>');
        // Numbered list lines like 1. 2.
        text = text.replace(/^\d+\. (.*)$/gm, '<li>$1</li>');
        text = text.replace(/(<li>.*<\/li>\n?)+/g, m=>m.includes('<ul>')?m:'<ol>'+m.replace(/\n/g,'')+'</ol>');
        // Paragraphs
        text = text.replace(/(^|\n)([^<\n][^\n]*)/g, (m, p1, p2)=> p2.trim()? `${p1}<p>${p2}</p>` : m);
        targetEl.innerHTML = text;
    }

    // Delegate clicks on timestamp links to seek the player
    document.addEventListener('click', function(e){
        var a = e.target.closest && e.target.closest('a.ts-link');
        if (!a) return;
        e.preventDefault();
        var ts = a.getAttribute('data-ts') || '';
        var parts = ts.split(':').map(Number);
        var seconds = 0;
        if (parts.length === 3) { seconds = parts[0]*3600 + parts[1]*60 + parts[2]; }
        else if (parts.length === 2) { seconds = parts[0]*60 + parts[1]; }
        if (isFinite(seconds)) { window.seekTo(seconds); }
    });

    async function getPromptTemplate(){ 
        try{ 
            // Prefer Phase 2 PROMPTS: analysis_prompt first, then assistant_prompt; fallback to legacy path
            let r = await fetch('/PROMPTS/analysis_prompt.txt');
            if (!r.ok) r = await fetch('/PROMPTS/assistant_prompt.txt');
            if (!r.ok) r = await fetch('/VIDEO_METADATA/assistant_prompt.txt');
            return await r.text(); 
        } catch(e){ 
            return 'You are an intelligent lesson analysis assistant.'; 
        } 
    }
    function transcriptAsText(){ try{ var list=mapTimestamps(currentTranscriptRaw||[]); return list.map(it=>'['+formatTime(it.start)+'] '+roleLabel(it)+': '+(it.text||'')).join('\n'); } catch(e){ return ''; } }

    // Voice capture -> transcription (for assistant chat)
    let chatMediaRecorder=null; let chunks=[]; let recording=false;
    async function toggleMic(){ const btn=document.getElementById('micBtn'); if(!recording){ try{ const stream=await navigator.mediaDevices.getUserMedia({audio:true}); chatMediaRecorder=new MediaRecorder(stream,{mimeType:'audio/webm'}); chunks=[]; chatMediaRecorder.ondataavailable=e=>{ if(e.data && e.data.size>0) chunks.push(e.data); }; chatMediaRecorder.onstop=async ()=>{ const blob=new Blob(chunks,{type:'audio/webm'}); const resp=await fetch('/api/realtime/transcribe',{method:'POST', headers:{'content-type':'audio/webm'}, body: blob}); const textBody=await resp.text(); let data; try{ data=JSON.parse(textBody);}catch{ data={ text: textBody }; } const text=data.text || data.transcript || textBody; document.getElementById('chatInput').value = text; }; chatMediaRecorder.start(); recording=true; btn.classList.remove('bg-sky-500'); btn.classList.add('bg-red-500','ring-2','ring-red-400'); } catch(e){ console.error('Mic error:', e); } } else { if(chatMediaRecorder && chatMediaRecorder.state!=='inactive') chatMediaRecorder.stop(); recording=false; btn.classList.remove('bg-red-500','ring-2','ring-red-400'); btn.classList.add('bg-sky-500'); } }

    // Analysis assistant streaming (adapted from onboarding)
    async function sendPrompt(){
        const input = document.getElementById('chatInput');
        const userText = input.value.trim();
        if (!userText) return;

        addMsg('user', userText);
        input.value = '';

        const basePrompt = await getPromptTemplate();
        const lesson = transcriptAsText();
        const payload = {
            prompt: basePrompt,
            text: 'User request: ' + userText + '\n\nFull lesson transcript (normalized to TEACHER/STUDENT):\n' + lesson
        };

        const thinkingBubble = addMsg('assistant', 'Thinking.');
        let thinkingDots = 1;
        const thinkingInterval = setInterval(() => {
            thinkingDots = (thinkingDots % 3) + 1;
            thinkingBubble.textContent = 'Thinking' + '.'.repeat(thinkingDots);
        }, 500);

        try {
            const response = await fetch('/api/analyze/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok || !response.body) throw new Error('Failed to get response');

            clearInterval(thinkingInterval);
            thinkingBubble.textContent = '';

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = '';
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                let idx;
                while ((idx = buffer.indexOf('\n')) !== -1) {
                    const rawLine = buffer.slice(0, idx);
                    buffer = buffer.slice(idx + 1);
                    const line = rawLine.trim();
                    if (!line || !line.startsWith('data:')) continue;
                    const dataStr = line.replace(/^data:\s*/, '').trim();
                    if (dataStr === '[DONE]') continue;
                    // Some environments may send 'data: [DONE]\r' or similar
                    if (dataStr.replace(/\r+$/, '') === '[DONE]') continue;
                    try {
                        const parsed = JSON.parse(dataStr);
                        if (parsed.content) {
                            fullResponse += parsed.content;
                            renderMarkdownLite(thinkingBubble, fullResponse);
                        } else if (parsed.error) {
                            throw new Error(parsed.error);
                        }
                    } catch (e) {
                        // Ignore non-JSON lines
                    }
                }
            }

            if (!fullResponse) {
                const backup = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const backupData = await backup.json();
                if (backup.ok && backupData.text) {
                    renderMarkdownLite(thinkingBubble, backupData.text);
                } else {
                    thinkingBubble.textContent = backupData.error || 'No response received.';
                }
            }
        } catch (err) {
            clearInterval(thinkingInterval);
            thinkingBubble.textContent = `Issue: ${String(err)}`;
        }
    }

    // ========== FLAG FUNCTIONS ==========
    async function loadFlags(sessionId){
        flaggedTimestamps.clear();
        try{ 
            const r=await fetch('/api/flags?sessionId='+encodeURIComponent(sessionId)); 
            if(r.ok){ 
                allFlags = await r.json(); 
                allFlags.forEach(f=>flaggedTimestamps.add(f.timestamp)); 
            } 
        }catch(e){console.error('Failed to load flags:',e);}
    }

    window.toggleFlag=async function(timestamp,speaker,text,role,event){
        event.stopPropagation(); if(!currentMeta) return;
        const isFlagged=flaggedTimestamps.has(timestamp);
        const btn = event.target.closest('.flag-btn');
        try{
            if(isFlagged){ 
                const flag=allFlags.find(f=>f.timestamp===timestamp); 
                if(flag){ 
                    await fetch('/api/flags/'+flag.id,{method:'DELETE'}); 
                    flaggedTimestamps.delete(timestamp); 
                    allFlags = allFlags.filter(f => f.id !== flag.id);
                    if(btn){ btn.classList.remove('flagged'); btn.title='Flag this'; }
                    
                    // If Flagged tab is currently visible, reload it
                    const flaggedTab = document.querySelector('.tab[data-tab="flagged"]');
                    if(flaggedTab && flaggedTab.classList.contains('active')){
                        loadFlaggedView(currentMeta.sessionId);
                    }
                }
            } else { 
                const r=await fetch('/api/flags',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({sessionId:currentMeta.sessionId,timestamp,text,speaker,role})}); 
                if(r.ok){ 
                    const newFlag = await r.json();
                    allFlags.push(newFlag);
                    flaggedTimestamps.add(timestamp); 
                    if(btn){ btn.classList.add('flagged'); btn.title='Unflag this'; }
                    
                    // If Flagged tab is currently visible, reload it
                    const flaggedTab = document.querySelector('.tab[data-tab="flagged"]');
                    if(flaggedTab && flaggedTab.classList.contains('active')){
                        loadFlaggedView(currentMeta.sessionId);
                    }
                }
            }
        }catch(e){console.error('Toggle flag error:',e);}
    };

    async function loadFlaggedView(sessionId){
        if(!sessionId && currentMeta) sessionId = currentMeta.sessionId;
        if(!sessionId) return;
        try{
            const r=await fetch('/api/flags?sessionId='+encodeURIComponent(sessionId));
            if(!r.ok) throw new Error('Failed to load flags');
            allFlags=await r.json(); 
            
            // Sync flaggedTimestamps with loaded flags
            flaggedTimestamps.clear();
            allFlags.forEach(f => flaggedTimestamps.add(f.timestamp));
            
            const box=document.getElementById('flaggedList');
            if(!allFlags.length){box.innerHTML='<div class="meta" style="text-align:center;padding:40px;color:var(--muted);">No flagged items yet.<br><small>Click the flag icon on any timestamp to flag it.</small></div>'; return;}
            box.innerHTML=allFlags.map((f,idx)=>{
                const time=formatTime(f.timestamp);
                const noteId='note_'+f.id;
                const micId='mic_'+f.id;
                const publishBtnId='publish_'+f.id;
                const isPublished = f.note && f.note.trim().length > 0;
                return '<div class="flagged-item"><div class="flagged-header"><div><span class="time-chip">'+time+'</span><strong style="margin-left:8px;">'+(f.role||'')+':</strong></div><div class="flagged-actions"><button onclick="window.seekTo('+f.timestamp+')" style="padding:4px 12px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;font-size:12px;">Jump</button><button onclick="removeFlag(\''+f.id+'\')" style="padding:4px 12px;border:1px solid #ef4444;color:#ef4444;border-radius:6px;background:#fff;cursor:pointer;font-size:12px;">Remove</button></div></div><div style="margin-top:8px;color:var(--muted);font-size:13px;">'+escapeHtml(f.text||'')+'</div><div class="flag-note-wrapper"><textarea id="'+noteId+'" class="flag-note" placeholder="Add notes..." onchange="updateFlagNote(\''+f.id+'\',this.value)">'+escapeHtml(f.note||'')+'</textarea><button id="'+micId+'" class="note-mic-btn" data-note-id="'+noteId+'" data-flag-id="'+f.id+'" title="Voice input"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg></button></div><button id="'+publishBtnId+'" class="publish-note-btn '+(isPublished?'published':'')+'" data-flag-id="'+f.id+'" data-note-id="'+noteId+'">'+(isPublished?'✓ Published':'Publish Note')+'</button></div>';
            }).join('');
            // Add event listeners for mic buttons and publish buttons
            document.querySelectorAll('.note-mic-btn').forEach(btn=>{
                btn.addEventListener('click', function(){ toggleNoteRecording(this); });
            });
            document.querySelectorAll('.publish-note-btn').forEach(btn=>{
                btn.addEventListener('click', function(){ publishNote(this); });
            });
            // Change Publish -> Update on edit
            document.querySelectorAll('.flag-note').forEach(textarea=>{
                textarea.addEventListener('input', function(){
                    const flagId = this.id.replace('note_', '');
                    const btn = document.getElementById('publish_'+flagId);
                    if(!btn) return;
                    const hasText = this.value.trim().length > 0;
                    if(hasText){
                        btn.textContent = btn.classList.contains('published') ? 'Update Note' : 'Publish Note';
                        btn.classList.add('update');
                        btn.classList.remove('published');
                    } else {
                        btn.textContent = 'Publish Note';
                        btn.classList.remove('update','published');
                    }
                });
            });
        }catch(e){console.error('Load flagged view error:',e); document.getElementById('flaggedList').innerHTML='<div class="meta">'+escapeHtml(e.message)+'</div>';}
    }

    // ========== PEDAGOGY SETTINGS ==========
    let pedagogyPreferences = {
        teachingSummary: true,
        teacherStudentTalk: true,
        waitTime: true,
        questionTypes: true,
        pedagogies: true,
        keyStrategies: true
    };
    
    async function loadPedagogyPreferences() {
        try {
            // Try to load from Supabase if we have email from onboarding
            const email = localStorage.getItem('teacher_email');
            if (email) {
                const response = await fetch(`/api/pedagogy/preferences?email=${encodeURIComponent(email)}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.preferences) {
                        pedagogyPreferences = data.preferences;
                        return;
                    }
                }
            }
        } catch (error) {
            console.log('Loading from localStorage instead');
        }
        
        // Fallback to localStorage
        const saved = localStorage.getItem('pedagogyPreferences');
        if (saved) {
            pedagogyPreferences = JSON.parse(saved);
        }
    }
    
    async function savePedagogyPreferences(prefs) {
        pedagogyPreferences = prefs;
        
        // Save to localStorage as backup
        localStorage.setItem('pedagogyPreferences', JSON.stringify(prefs));
        
        // Try to save to Supabase
        try {
            const email = localStorage.getItem('teacher_email');
            if (email) {
                await fetch('/api/pedagogy/preferences', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, preferences: prefs })
                });
            }
        } catch (error) {
            console.error('Error saving to Supabase:', error);
        }
    }
    
    function openPedagogySettings() {
        const modal = document.getElementById('pedagogySettingsModal');
        modal.style.display = 'flex';
        
        // Set checkboxes based on current preferences
        document.getElementById('setting_teachingSummary').checked = pedagogyPreferences.teachingSummary;
        document.getElementById('setting_teacherStudentTalk').checked = pedagogyPreferences.teacherStudentTalk;
        document.getElementById('setting_waitTime').checked = pedagogyPreferences.waitTime;
        document.getElementById('setting_questionTypes').checked = pedagogyPreferences.questionTypes;
        document.getElementById('setting_pedagogies').checked = pedagogyPreferences.pedagogies;
        document.getElementById('setting_keyStrategies').checked = pedagogyPreferences.keyStrategies;
    }
    
    function closePedagogySettings() {
        document.getElementById('pedagogySettingsModal').style.display = 'none';
    }
    
    async function saveAndClosePedagogySettings() {
        const newPrefs = {
            teachingSummary: document.getElementById('setting_teachingSummary').checked,
            teacherStudentTalk: document.getElementById('setting_teacherStudentTalk').checked,
            waitTime: document.getElementById('setting_waitTime').checked,
            questionTypes: document.getElementById('setting_questionTypes').checked,
            pedagogies: document.getElementById('setting_pedagogies').checked,
            keyStrategies: document.getElementById('setting_keyStrategies').checked
        };
        
        await savePedagogyPreferences(newPrefs);
        closePedagogySettings();
        
        // Reload the pedagogy view with new preferences
        if (currentMeta) {
            loadPedagogyView(currentMeta.sessionId);
        }
    }

    // ========== PEDAGOGY VIEW HELPERS ==========
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return mins + ':' + (secs < 10 ? '0' : '') + secs;
    }

    function toggleTalkView() {
        const combined = document.getElementById('combinedTalkView');
        const split = document.getElementById('splitTalkView');
        
        if (combined.style.display === 'none') {
            // Show vertical split view
            combined.style.display = 'block';
            split.style.display = 'none';
        } else {
            // Show barcode view
            combined.style.display = 'none';
            split.style.display = 'block';
        }
    }

    // ========== PEDAGOGY VIEW ==========
    async function loadPedagogyView(sessionId){
        if(!sessionId && currentMeta) sessionId = currentMeta.sessionId;
        if(!sessionId) return;
        
        const box=document.getElementById('pedagogyView');
        box.innerHTML='<div style="text-align:center;padding:20px;"><div style="font-size:24px;">⏳</div><div style="color:var(--muted);">Loading pedagogy analysis...</div></div>';
        
        try{
            const r=await fetch('/api/pedagogy?sessionId='+encodeURIComponent(sessionId));
            if(!r.ok) throw new Error('Failed to load pedagogy analysis');
            const data=await r.json();
            
            if(!data || !data.pedagogy_analysis){
                box.innerHTML='<div class="meta" style="text-align:center;padding:40px;color:var(--muted);">No pedagogy analysis available for this lesson.<br><small>Run Phase 3 pipeline to generate analysis.</small></div>';
                return;
            }
            
            // Store word-level transcript in memory for wait time analysis
            window.currentWordTranscript = data.wordTranscript || null;
            if (window.currentWordTranscript) {
                console.log('✅ Word-level transcript loaded:', window.currentWordTranscript.words?.length || 0, 'words');
            } else {
                console.log('⚠️ No word-level transcript available');
            }
            
            const p = data.pedagogy_analysis;
            const qa = p.question_analysis || {};
            const summary = qa.summary || {};
            const qCounts = summary.question_type_counts || {};
            const overall = p.overall_pedagogy || {};
            const peds = overall.pedagogies_identified || [];
            
            // Calculate teacher vs student talk time and build timeline
            const transcript = data.transcript || [];
            let teacherTime = 0;
            let studentTime = 0;
            
            // Find total lesson duration
            let maxTime = 0;
            transcript.forEach(seg => {
                const duration = (seg.end || 0) - (seg.start || 0);
                if (seg.role === 'TEACHER') {
                    teacherTime += duration;
                } else if (seg.role === 'STUDENT') {
                    studentTime += duration;
                }
                maxTime = Math.max(maxTime, seg.end || 0);
            });
            
            const totalDurationSeconds = Math.ceil(maxTime);
            // Calculate available width based on actual pedagogy container
            const pedagogyBox = document.getElementById('pedagogyView');
            const availableWidth = pedagogyBox ? pedagogyBox.clientWidth - 80 : 600; // Leave room for padding
            const containerWidth = Math.min(availableWidth, 700);
            const pixelsPerSecond = containerWidth / totalDurationSeconds;
            
            // Build timeline: for each second, determine who's speaking
            const timeline = new Array(totalDurationSeconds).fill('blank');
            transcript.forEach(seg => {
                const startSec = Math.floor(seg.start || 0);
                const endSec = Math.ceil(seg.end || 0);
                for (let i = startSec; i < endSec && i < totalDurationSeconds; i++) {
                    timeline[i] = seg.role === 'TEACHER' ? 'teacher' : 'student';
                }
            });
            
            const totalTime = teacherTime + studentTime;
            const talkTime = {
                teacherTime: Math.round(teacherTime),
                studentTime: Math.round(studentTime),
                teacherPercent: totalTime > 0 ? Math.round((teacherTime / totalTime) * 100) : 0,
                studentPercent: totalTime > 0 ? Math.round((studentTime / totalTime) * 100) : 0,
                totalTime: totalTime
            };
            
            let html = '';
            
            // Overall Summary
            if(pedagogyPreferences.teachingSummary && overall.summary){
                html += '<div style="background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;">';
                html += '<h3 style="margin:0 0 8px 0;font-size:16px;font-weight:700;">📊 Teaching Summary</h3>';
                html += '<p style="margin:0;line-height:1.6;color:#1e293b;">'+escapeHtml(overall.summary)+'</p>';
                html += '</div>';
            }
            
            // Teacher vs Student Talk Time
            if(pedagogyPreferences.teacherStudentTalk){
            html += '<div style="background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">';
            html += '<h3 style="margin:0;font-size:16px;font-weight:700;">🗣️ Teacher vs Student Talk</h3>';
            html += '<button onclick="toggleTalkView()" style="padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:white;cursor:pointer;font-size:13px;">Toggle View</button>';
            html += '</div>';
            
            // Stats on the side
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">';
            html += '<div style="padding:12px;background:#eff6ff;border-radius:8px;">';
            html += '<div style="font-size:12px;color:#64748b;margin-bottom:4px;">Teacher Talk</div>';
            html += '<div style="font-size:20px;font-weight:700;color:#3b82f6;">'+formatTime(talkTime.teacherTime)+' <span style="font-size:14px;font-weight:600;">('+talkTime.teacherPercent+'%)</span></div>';
            html += '</div>';
            html += '<div style="padding:12px;background:#fef3c7;border-radius:8px;">';
            html += '<div style="font-size:12px;color:#64748b;margin-bottom:4px;">Student Talk</div>';
            html += '<div style="font-size:20px;font-weight:700;color:#f59e0b;">'+formatTime(talkTime.studentTime)+' <span style="font-size:14px;font-weight:600;">('+talkTime.studentPercent+'%)</span></div>';
            html += '</div>';
            html += '</div>';
            
            // View 1: Vertical Split (default) - two rows showing teacher/student separately
            html += '<div id="combinedTalkView">';
            html += '<div style="background:#f8fafc;border-radius:8px;padding:12px;max-width:100%;overflow:hidden;">';
            html += '<div style="margin-bottom:4px;"><small style="color:#64748b;">Teacher</small></div>';
            html += '<div style="display:flex;height:30px;max-width:100%;background:white;border-radius:4px;overflow:hidden;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">';
            
            // Draw teacher timeline (barcode style)
            for (let i = 0; i < timeline.length; i++) {
                const color = timeline[i] === 'teacher' ? '#3b82f6' : '#ffffff';
                html += '<div style="flex:0 0 '+pixelsPerSecond+'px;height:100%;background:'+color+';"></div>';
            }
            
            html += '</div>';
            html += '<div style="margin-bottom:4px;"><small style="color:#64748b;">Student</small></div>';
            html += '<div style="display:flex;height:30px;max-width:100%;background:white;border-radius:4px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1);">';
            
            // Draw student timeline (barcode style)
            for (let i = 0; i < timeline.length; i++) {
                const color = timeline[i] === 'student' ? '#f59e0b' : '#ffffff';
                html += '<div style="flex:0 0 '+pixelsPerSecond+'px;height:100%;background:'+color+';"></div>';
            }
            
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // View 2: Mixed barcode (hidden) - single bar with all segments
            html += '<div id="splitTalkView" style="display:none;">';
            html += '<div style="background:#f8fafc;border-radius:8px;padding:12px;max-width:100%;overflow:hidden;">';
            html += '<div style="margin-bottom:4px;"><small style="color:#64748b;">Teacher & Student (chronological)</small></div>';
            html += '<div style="display:flex;height:40px;max-width:100%;background:white;border-radius:4px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1);">';
            
            // Draw mixed timeline (barcode style)
            for (let i = 0; i < timeline.length; i++) {
                let color = '#ffffff'; // blank
                if (timeline[i] === 'teacher') color = '#3b82f6';
                if (timeline[i] === 'student') color = '#f59e0b';
                html += '<div style="flex:0 0 '+pixelsPerSecond+'px;height:100%;background:'+color+';"></div>';
            }
            
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
            }
            
            // Wait Time Analysis
            const waitTimes = p.wait_time_analysis;
            if (pedagogyPreferences.waitTime && waitTimes && waitTimes.count > 0) {
                html += '<div style="background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;">';
                html += '<h3 style="margin:0 0 16px 0;font-size:16px;font-weight:700;">⏱️ Wait Time After Questions</h3>';
                
                // Stats grid
                html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;">';
                html += '<div style="padding:12px;background:#f0fdf4;border-radius:8px;text-align:center;">';
                html += '<div style="font-size:12px;color:#64748b;margin-bottom:4px;">Average</div>';
                html += '<div style="font-size:24px;font-weight:700;color:#10b981;">'+waitTimes.average+'s</div>';
                html += '</div>';
                html += '<div style="padding:12px;background:#eff6ff;border-radius:8px;text-align:center;">';
                html += '<div style="font-size:12px;color:#64748b;margin-bottom:4px;">Min</div>';
                html += '<div style="font-size:20px;font-weight:700;color:#3b82f6;">'+waitTimes.min+'s</div>';
                html += '</div>';
                html += '<div style="padding:12px;background:#fef3c7;border-radius:8px;text-align:center;">';
                html += '<div style="font-size:12px;color:#64748b;margin-bottom:4px;">Max</div>';
                html += '<div style="font-size:20px;font-weight:700;color:#f59e0b;">'+waitTimes.max+'s</div>';
                html += '</div>';
                html += '</div>';
                
                // Histogram
                html += '<div style="margin-top:16px;">';
                html += '<div style="font-size:13px;font-weight:600;color:#64748b;margin-bottom:8px;">Distribution ('+waitTimes.count+' questions)</div>';
                html += '<div style="display:flex;align-items:end;gap:4px;height:100px;padding:8px;background:#f8fafc;border-radius:6px;">';
                
                // Create histogram bins
                const bins = [0, 1, 2, 3, 5, 8, 30];  // 0-1s, 1-2s, 2-3s, 3-5s, 5-8s, 8+s
                const binCounts = new Array(bins.length - 1).fill(0);
                waitTimes.distribution.forEach(wt => {
                    for (let i = 0; i < bins.length - 1; i++) {
                        if (wt >= bins[i] && wt < bins[i+1]) {
                            binCounts[i]++;
                            break;
                        }
                    }
                });
                
                const maxCount = Math.max(...binCounts, 1);
                binCounts.forEach((count, i) => {
                    const height = (count / maxCount) * 100;
                    const label = i === binCounts.length - 1 ? bins[i]+'s+' : bins[i]+'-'+bins[i+1]+'s';
                    html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;">';
                    html += '<div style="font-size:11px;font-weight:600;color:#3b82f6;margin-bottom:2px;">'+count+'</div>';
                    html += '<div style="width:100%;background:#3b82f6;border-radius:4px 4px 0 0;height:'+height+'%;min-height:'+(count>0?'8px':'0')+';"></div>';
                    html += '<div style="font-size:10px;color:#64748b;margin-top:4px;">'+label+'</div>';
                    html += '</div>';
                });
                
                html += '</div></div>';
                html += '<div style="margin-top:12px;padding:10px;background:#fef3c7;border-radius:6px;font-size:12px;color:#92400e;">';
                html += '💡 Research suggests 3-5 seconds of wait time increases response quality and student engagement.';
                html += '</div>';
                html += '</div>';
            }
            
            // Question Type Breakdown
            if(pedagogyPreferences.questionTypes){
            html += '<div style="background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;">';
            html += '<h3 style="margin:0 0 12px 0;font-size:16px;font-weight:700;">❓ Question Types</h3>';
            html += '<div style="font-size:24px;font-weight:800;color:#3b82f6;margin-bottom:12px;">'+summary.total_questions_analyzed+' Total Questions</div>';
            const qTypes = [
                {key:'whole-class',label:'Whole Class',icon:'👥',color:'#3b82f6'},
                {key:'rhetorical',label:'Rhetorical',icon:'💭',color:'#8b5cf6'},
                {key:'cold-call',label:'Cold Call',icon:'👤',color:'#ef4444'},
                {key:'hand-raising',label:'Hand Raising',icon:'✋',color:'#f59e0b'},
                {key:'warm-call',label:'Warm Call',icon:'🙋',color:'#10b981'}
            ];
            qTypes.forEach(qt=>{
                const count = qCounts[qt.key] || 0;
                if(count > 0){
                    const pct = summary.total_questions_analyzed > 0 ? Math.round((count / summary.total_questions_analyzed) * 100) : 0;
                    html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;padding:8px;border-radius:8px;background:#f8fafc;">';
                    html += '<span style="font-size:20px;">'+qt.icon+'</span>';
                    html += '<div style="flex:1;"><div style="font-weight:600;color:#1e293b;">'+qt.label+'</div><div style="font-size:12px;color:var(--muted);">'+count+' questions ('+pct+'%)</div></div>';
                    html += '<div style="width:60px;height:4px;background:#e5e7eb;border-radius:2px;overflow:hidden;"><div style="width:'+pct+'%;height:100%;background:'+qt.color+';"></div></div>';
                    html += '</div>';
                }
            });
            html += '</div>';
            }
            
            // Pedagogies Identified
            if(pedagogyPreferences.pedagogies && peds.length > 0){
                html += '<div style="background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;">';
                html += '<h3 style="margin:0 0 12px 0;font-size:16px;font-weight:700;">🎓 Pedagogies Identified</h3>';
                peds.forEach(ped=>{
                    const freqColor = ped.frequency==='high' ? '#10b981' : ped.frequency==='medium' ? '#f59e0b' : '#6b7280';
                    html += '<div style="margin-bottom:12px;padding:12px;border-left:3px solid '+freqColor+';background:#f8fafc;border-radius:6px;">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:4px;">';
                    html += '<strong style="color:#1e293b;text-transform:capitalize;">'+escapeHtml(ped.pedagogy)+'</strong>';
                    html += '<span style="font-size:11px;padding:2px 8px;border-radius:12px;background:'+freqColor+';color:white;font-weight:600;text-transform:uppercase;">'+escapeHtml(ped.frequency)+'</span>';
                    html += '</div>';
                    html += '<div style="font-size:13px;color:#64748b;line-height:1.5;">'+escapeHtml(ped.evidence)+'</div>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // Key Strategies
            if(pedagogyPreferences.keyStrategies && overall.key_strategies && overall.key_strategies.length > 0){
                html += '<div style="background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:20px;">';
                html += '<h3 style="margin:0 0 12px 0;font-size:16px;font-weight:700;">💡 Key Teaching Strategies</h3>';
                html += '<ul style="margin:0;padding-left:20px;">';
                overall.key_strategies.forEach(s=>{
                    html += '<li style="margin-bottom:6px;color:#1e293b;line-height:1.5;">'+escapeHtml(s)+'</li>';
                });
                html += '</ul></div>';
            }
            
            box.innerHTML = html;
            
        }catch(e){
            console.error('Load pedagogy view error:',e);
            box.innerHTML='<div class="meta" style="text-align:center;padding:40px;color:var(--muted);">❌ Error loading pedagogy analysis<br><small>'+escapeHtml(e.message)+'</small></div>';
        }
    }

    window.removeFlag=async function(id){
        try{
            // Find the flag to get its timestamp
            const flag = allFlags.find(f => f.id === id);
            if(!flag) return;
            
            await fetch('/api/flags/'+id,{method:'DELETE'}); 
            
            // Remove from local state
            flaggedTimestamps.delete(flag.timestamp);
            allFlags = allFlags.filter(f => f.id !== id);
            
            // Update Timestamps tab UI - find all flag buttons and update the one matching this timestamp
            document.querySelectorAll('.flag-btn').forEach(btn => {
                const ts = parseInt(btn.dataset.ts);
                if(ts === flag.timestamp){
                    btn.classList.remove('flagged');
                    btn.title = 'Flag this';
                }
            });
            
            // Reload Flagged view
            if(currentMeta) loadFlaggedView(currentMeta.sessionId);
        }catch(e){console.error('Remove flag error:',e);}
    };

    window.updateFlagNote=async function(id,note){
        try{await fetch('/api/flags/'+id,{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify({note})});}catch(e){console.error('Update note error:',e);}
    };

    // Publish note to Supabase
    async function publishNote(btn){
        const flagId = btn.dataset.flagId;
        const noteId = btn.dataset.noteId;
        const textarea = document.getElementById(noteId);
        const note = textarea.value.trim();
        
        if(!note){
            alert('Please add some notes before publishing');
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Publishing...';
        
        try{
            await fetch('/api/flags/'+flagId, {
                method: 'PUT',
                headers: {'content-type':'application/json'},
                body: JSON.stringify({note})
            });
            
            btn.textContent = '✓ Published';
            btn.classList.add('published');
            btn.classList.remove('update');
            
            setTimeout(() => {
                btn.disabled = false;
            }, 1000);
        }catch(e){
            console.error('Publish error:', e);
            alert('Failed to publish note');
            btn.disabled = false;
            btn.textContent = 'Publish Note';
        }
    }

    // Voice recording for notes
    var noteRecorders = {};
    async function toggleNoteRecording(btn){
        const noteId = btn.dataset.noteId;
        const flagId = btn.dataset.flagId;
        const textarea = document.getElementById(noteId);
        
        if(noteRecorders[noteId]){
            // Stop recording
            noteRecorders[noteId].stop();
            btn.classList.remove('recording');
            delete noteRecorders[noteId];
        } else {
            // Start recording
            try{
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const recorder = new MediaRecorder(stream);
                const chunks = [];
                
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = async () => {
                    stream.getTracks().forEach(t => t.stop());
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    const arrayBuffer = await blob.arrayBuffer();
                    
                    try{
                        const r = await fetch('/api/realtime/transcribe', { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/octet-stream' },
                            body: arrayBuffer 
                        });
                        if(!r.ok) throw new Error('Transcription failed');
                        const data = await r.json();
                        const text = data.text || '';
                        textarea.value = (textarea.value ? textarea.value + ' ' : '') + text;
                        updateFlagNote(flagId, textarea.value);
                    }catch(e){
                        console.error('Note transcription error:', e);
                    }
                };
                
                recorder.start();
                noteRecorders[noteId] = recorder;
                btn.classList.add('recording');
            }catch(e){
                console.error('Microphone error:', e);
                alert('Could not access microphone');
            }
        }
    }

    // ========== PROGRESS VIEW ==========
    
    function initializeProgressFilters() {
        // Set default: 2 months from today
        const today = new Date();
        const twoMonthsAgo = new Date();
        twoMonthsAgo.setMonth(today.getMonth() - 2);
        
        // Format dates for input fields (YYYY-MM-DD)
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        document.getElementById('progressFromDate').value = formatDate(twoMonthsAgo);
        document.getElementById('progressToDate').value = formatDate(today);
    }
    
    async function loadProgressView(useFilters = true) {
        const progressContent = document.getElementById('progressContent');
        progressContent.innerHTML = '<div style="text-align:center;padding:60px 20px;color:var(--muted);"><div style="font-size:18px;">Loading your progress...</div></div>';
        
        // Initialize filters if not already set
        if (!document.getElementById('progressFromDate').value) {
            initializeProgressFilters();
        }
        
        try {
            // Build query string with filters
            let url = '/api/progress';
            if (useFilters) {
                const fromDate = document.getElementById('progressFromDate').value;
                const toDate = document.getElementById('progressToDate').value;
                url += `?fromDate=${encodeURIComponent(fromDate)}&toDate=${encodeURIComponent(toDate)}`;
            }
            
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load progress data');
            const data = await response.json();
            
            renderProgressView(data);
        } catch (error) {
            console.error('Error loading progress:', error);
            progressContent.innerHTML = '<div style="text-align:center;padding:60px 20px;color:var(--muted);"><div style="font-size:18px;font-weight:600;">Error loading progress data</div><div style="font-size:14px;margin-top:8px;">'+escapeHtml(error.message)+'</div></div>';
        }
    }
    
    let currentProgressLessons = []; // Store for report generation
    
    function getSelectedLessons() {
        // Get checked lesson checkboxes and filter currentProgressLessons
        const checkedBoxes = Array.from(document.querySelectorAll('.lesson-select-checkbox:checked'));
        const selectedSessionIds = checkedBoxes.map(cb => cb.dataset.sessionId);
        return currentProgressLessons.filter(lesson => selectedSessionIds.includes(lesson.sessionId));
    }
    
    function renderProgressView(data) {
        const progressContent = document.getElementById('progressContent');
        const lessons = data.lessons || [];
        currentProgressLessons = lessons; // Store for report generation
        
        if (lessons.length === 0) {
            progressContent.innerHTML = '<div style="text-align:center;padding:60px 20px;color:var(--muted);"><div style="font-size:18px;font-weight:600;">No lessons yet</div><div style="font-size:14px;margin-top:8px;">Upload your first lesson to start tracking progress</div></div>';
            return;
        }
        
        let html = '';
        
        // Lesson Timeline (simplified list at top)
        html += '<div style="background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:24px 32px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">';
        html += '<h2 style="margin:0 0 20px 0;font-size:20px;font-weight:700;">Lessons in Range</h2>';
        html += '<div style="display:flex;flex-direction:column;gap:12px;">';
        
        lessons.slice().reverse().forEach((lesson, idx) => {
            const date = new Date(lesson.uploadedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            html += '<div style="display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;background:#f8fafc;">';
            html += '<input type="checkbox" class="lesson-select-checkbox" data-session-id="'+escapeHtml(lesson.sessionId)+'" checked style="width:18px;height:18px;cursor:pointer;accent-color:#3b82f6;">';
            html += '<div style="font-size:13px;color:#64748b;min-width:100px;">'+date+'</div>';
            html += '<div style="font-size:15px;font-weight:600;color:#1e293b;flex:1;">'+escapeHtml(lesson.title)+'</div>';
            html += '</div>';
        });
        
        html += '</div>';
        html += '</div>';
        
        // Metrics Over Time
        html += '<div style="background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:32px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">';
        html += '<h2 style="margin:0 0 24px 0;font-size:20px;font-weight:700;">Metrics Over Time</h2>';
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;">';
        
        // Calculate averages
        const avgTeacherTalk = lessons.reduce((sum, l) => sum + (l.teacherTalkPercent || 0), 0) / lessons.length;
        const avgWaitTime = lessons.reduce((sum, l) => sum + (l.avgWaitTime || 0), 0) / lessons.filter(l => l.avgWaitTime).length;
        const totalQuestions = lessons.reduce((sum, l) => sum + (l.totalQuestions || 0), 0);
        
        html += '<div style="padding:20px;background:#eff6ff;border-radius:8px;">';
        html += '<div style="font-size:14px;color:#64748b;margin-bottom:8px;">Avg Teacher Talk</div>';
        html += '<div style="font-size:32px;font-weight:700;color:#3b82f6;">'+Math.round(avgTeacherTalk)+'%</div>';
        html += '</div>';
        
        html += '<div style="padding:20px;background:#f0fdf4;border-radius:8px;">';
        html += '<div style="font-size:14px;color:#64748b;margin-bottom:8px;">Avg Wait Time</div>';
        html += '<div style="font-size:32px;font-weight:700;color:#10b981;">'+avgWaitTime.toFixed(1)+'s</div>';
        html += '</div>';
        
        html += '<div style="padding:20px;background:#fef3c7;border-radius:8px;">';
        html += '<div style="font-size:14px;color:#64748b;margin-bottom:8px;">Total Questions</div>';
        html += '<div style="font-size:32px;font-weight:700;color:#f59e0b;">'+totalQuestions+'</div>';
        html += '</div>';
        
        html += '<div style="padding:20px;background:#fce7f3;border-radius:8px;">';
        html += '<div style="font-size:14px;color:#64748b;margin-bottom:8px;">Total Lessons</div>';
        html += '<div style="font-size:32px;font-weight:700;color:#ec4899;">'+lessons.length+'</div>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
        
        // Individual Lesson Metrics
        html += '<div style="background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:32px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">';
        html += '<h2 style="margin:0 0 20px 0;font-size:20px;font-weight:700;">Lesson Details</h2>';
        html += '<div style="overflow-x:auto;">';
        html += '<table style="width:100%;border-collapse:collapse;font-size:14px;">';
        html += '<thead><tr style="border-bottom:2px solid var(--border);text-align:left;">';
        html += '<th style="padding:12px 8px;font-weight:600;color:#64748b;">Date</th>';
        html += '<th style="padding:12px 8px;font-weight:600;color:#64748b;">Lesson</th>';
        html += '<th style="padding:12px 8px;font-weight:600;color:#64748b;">Teacher Talk</th>';
        html += '<th style="padding:12px 8px;font-weight:600;color:#64748b;">Wait Time</th>';
        html += '<th style="padding:12px 8px;font-weight:600;color:#64748b;">Questions</th>';
        html += '</tr></thead>';
        html += '<tbody>';
        
        lessons.slice().reverse().forEach((lesson) => {
            const date = new Date(lesson.uploadedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            html += '<tr style="border-bottom:1px solid #f1f5f9;">';
            html += '<td style="padding:12px 8px;color:#64748b;">'+date+'</td>';
            html += '<td style="padding:12px 8px;font-weight:500;color:#1e293b;">'+escapeHtml(lesson.title)+'</td>';
            html += '<td style="padding:12px 8px;"><span style="display:inline-block;padding:4px 12px;background:#eff6ff;color:#3b82f6;border-radius:12px;font-weight:600;">'+Math.round(lesson.teacherTalkPercent || 0)+'%</span></td>';
            html += '<td style="padding:12px 8px;"><span style="display:inline-block;padding:4px 12px;background:#f0fdf4;color:#10b981;border-radius:12px;font-weight:600;">'+(lesson.avgWaitTime ? lesson.avgWaitTime.toFixed(1)+'s' : 'N/A')+'</span></td>';
            html += '<td style="padding:12px 8px;"><span style="display:inline-block;padding:4px 12px;background:#fef3c7;color:#f59e0b;border-radius:12px;font-weight:600;">'+(lesson.totalQuestions || 0)+'</span></td>';
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        html += '</div>';
        html += '</div>';
        
        // AI Analysis Section with Chat Interface
        html += '<div id="aiReportSection" style="background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:32px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">';
        html += '<h2 style="margin:0 0 8px 0;font-size:20px;font-weight:700;">AI Analysis</h2>';
        html += '<p style="margin:0 0 20px 0;font-size:14px;color:var(--muted);">Ask questions about your teaching progress</p>';
        
        // Special Goals & Research Analysis Button
        html += '<div style="margin-bottom:24px;padding:16px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);border-radius:12px;">';
        html += '<button id="goalsResearchAnalysisBtn" style="width:100%;padding:14px 20px;border:2px solid white;border-radius:8px;background:rgba(255,255,255,0.95);color:#059669;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:10px;">';
        html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:20px;height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
        html += 'Analyze Progress Towards My Goals & Research';
        html += '</button>';
        html += '<div style="font-size:12px;color:white;margin-top:8px;text-align:center;opacity:0.9;">Review how well you\'re meeting your teaching goals and applying research-backed strategies</div>';
        html += '</div>';
        
        // Suggested Questions
        html += '<div style="margin-bottom:20px;">';
        html += '<div style="font-size:13px;font-weight:600;color:#64748b;margin-bottom:12px;">Suggested Questions:</div>';
        html += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
        
        const suggestedQuestions = [
            { text: "How has my wait time improved?", tooltip: "Analyzes changes in your pause times after questions over time" },
            { text: "Am I giving students more voice?", tooltip: "Analyzes teacher talk vs student talk trends" },
            { text: "What questioning strategies work best?", tooltip: "Reviews your question types and their effectiveness" },
            { text: "How do I compare to research standards?", tooltip: "Compares your metrics to research-backed best practices" },
            { text: "What should I focus on next?", tooltip: "Provides personalized recommendations based on your data" }
        ];
        
        suggestedQuestions.forEach((q, idx) => {
            html += '<button class="suggested-question-btn" data-question="'+escapeHtml(q.text)+'" title="'+escapeHtml(q.tooltip)+'" style="padding:8px 16px;border:1px solid #e5e7eb;border-radius:20px;background:white;color:#374151;font-size:13px;cursor:pointer;transition:all 0.2s;white-space:nowrap;">'+escapeHtml(q.text)+'</button>';
        });
        
        html += '</div>';
        html += '</div>';
        
        // Chat/Response Area
        html += '<div id="aiAnalysisMessages" style="min-height:200px;max-height:500px;overflow-y:auto;padding:16px;background:#f8fafc;border-radius:8px;margin-bottom:16px;"></div>';
        
        // Input Area
        html += '<div style="display:flex;gap:8px;align-items:flex-start;">';
        html += '<button id="aiAnalysisMicBtn" style="flex-shrink:0;display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:50%;background:#3b82f6;color:white;border:none;cursor:pointer;transition:all 0.2s;margin-top:0;" title="Voice input"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:20px;height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v3m0 0h-3m3 0h3M8.25 9v3a3.75 3.75 0 007.5 0V9m-7.5 0A3.75 3.75 0 0112 5.25v0A3.75 3.75 0 0115.75 9v3A3.75 3.75 0 0112 15.75v0A3.75 3.75 0 018.25 12V9z" /></svg></button>';
        html += '<textarea id="aiAnalysisInput" rows="2" placeholder="Ask a question about your teaching progress..." style="flex:1;padding:12px 16px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit;resize:vertical;min-height:44px;"></textarea>';
        html += '<button id="aiAnalysisSendBtn" style="padding:0 24px;height:44px;border:none;border-radius:8px;background:var(--accent);color:white;font-weight:600;cursor:pointer;transition:all 0.2s;">Ask</button>';
        html += '</div>';
        
        html += '</div>';
        
        progressContent.innerHTML = html;
        
        // Add event listeners for AI Analysis section
        setTimeout(() => {
            setupAIAnalysisListeners();
        }, 100);
    }
    
    let aiAnalysisRecorder = null;
    let aiAnalysisRecording = false;
    
    function setupAIAnalysisListeners() {
        // Goals & Research Analysis Button
        const goalsBtn = document.getElementById('goalsResearchAnalysisBtn');
        if (goalsBtn) {
            goalsBtn.addEventListener('click', () => {
                const question = "Based on my teaching goals and the research-backed strategies I selected, how am I doing? Please provide specific feedback on my progress towards my goals and how well I'm implementing the recommended teaching strategies.";
                sendAIAnalysisQuestion(question, true); // true = include goals & research
            });
        }
        
        // Suggested question buttons
        document.querySelectorAll('.suggested-question-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const question = btn.dataset.question;
                sendAIAnalysisQuestion(question);
            });
        });
        
        // Send button
        const sendBtn = document.getElementById('aiAnalysisSendBtn');
        if (sendBtn) {
            sendBtn.addEventListener('click', () => {
                const input = document.getElementById('aiAnalysisInput');
                const question = input.value.trim();
                if (question) {
                    sendAIAnalysisQuestion(question);
                    input.value = '';
                }
            });
        }
        
        // Enter key to send
        const input = document.getElementById('aiAnalysisInput');
        if (input) {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const question = input.value.trim();
                    if (question) {
                        sendAIAnalysisQuestion(question);
                        input.value = '';
                    }
                }
            });
        }
        
        // Mic button
        const micBtn = document.getElementById('aiAnalysisMicBtn');
        if (micBtn) {
            micBtn.addEventListener('click', toggleAIAnalysisRecording);
        }
    }
    
    function addAIAnalysisMessage(content, isUser = false) {
        const messagesDiv = document.getElementById('aiAnalysisMessages');
        if (!messagesDiv) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `margin-bottom:16px;display:flex;${isUser ? 'justify-content:flex-end' : 'justify-content:flex-start'};`;
        
        const bubble = document.createElement('div');
        bubble.style.cssText = `max-width:80%;padding:12px 16px;border-radius:12px;${isUser ? 'background:#3b82f6;color:white;' : 'background:white;border:1px solid #e5e7eb;color:#1e293b;'}font-size:14px;line-height:1.6;`;
        
        if (isUser) {
            bubble.textContent = content;
        } else {
            // Format AI response with better markdown handling
            bubble.classList.add('ai-response-content');
            let formatted = escapeHtml(content);
            
            // Parse and convert markdown tables to HTML tables
            const tableRegex = /(\|.+\|\n)+/g;
            formatted = formatted.replace(tableRegex, (tableMatch) => {
                const rows = tableMatch.trim().split('\n').filter(row => row.includes('|'));
                if (rows.length < 2) return tableMatch;
                
                // Check if second row is separator (|---|---|)
                const isSeparatorRow = (row) => /^\|[\s\-\|]+\|$/.test(row);
                const hasSeparator = isSeparatorRow(rows[1]);
                
                const parseRow = (row) => {
                    return row.split('|')
                        .slice(1, -1) // Remove empty first and last elements
                        .map(cell => cell.trim());
                };
                
                let html = '<table style="border-collapse:collapse;width:100%;margin:12px 0;font-size:13px;"><thead>';
                
                // Header row
                const headers = parseRow(rows[0]);
                html += '<tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb;">';
                headers.forEach(header => {
                    html += `<th style="padding:10px 12px;text-align:left;font-weight:600;color:#374151;border:1px solid #e5e7eb;">${header}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                // Data rows (skip separator if present)
                const dataRows = hasSeparator ? rows.slice(2) : rows.slice(1);
                dataRows.forEach((row, idx) => {
                    if (isSeparatorRow(row)) return;
                    const cells = parseRow(row);
                    const bgColor = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    html += `<tr style="background:${bgColor};">`;
                    cells.forEach(cell => {
                        html += `<td style="padding:8px 12px;border:1px solid #e5e7eb;color:#1e293b;">${cell}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                return html;
            });
            
            // Convert --- separators to spacing
            formatted = formatted.replace(/\n---\n/g, '<div style="margin:10px 0;"></div>');
            
            // Convert markdown-style bold
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert ### headers to bold headers with spacing
            formatted = formatted.replace(/###\s+(.*?)(?=\n|$)/g, '<div style="font-weight:600;margin-top:14px;margin-bottom:6px;color:#1e293b;font-size:15px;">$1</div>');
            
            // Convert list items (lines starting with - or *)
            formatted = formatted.replace(/\n([•\-\*])\s+/g, '\n<br>• ');
            
            // Convert double line breaks to moderate paragraph spacing
            formatted = formatted.replace(/\n\n/g, '<div style="margin:8px 0;"></div>');
            
            // Convert remaining single line breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            bubble.innerHTML = formatted;
        }
        
        messageDiv.appendChild(bubble);
        messagesDiv.appendChild(messageDiv);
        
        // Scroll to show the new message (not the very bottom)
        if (!isUser) {
            // For AI messages, scroll to show the message itself
            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        } else {
            // For user messages, just scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }
    
    async function sendAIAnalysisQuestion(question, includeGoals = false) {
        if (!question.trim()) return;
        
        // Add user message
        addAIAnalysisMessage(question, true);
        
        // Add loading message
        const messagesDiv = document.getElementById('aiAnalysisMessages');
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'aiAnalysisLoading';
        loadingDiv.style.cssText = 'margin-bottom:16px;display:flex;justify-content:flex-start;';
        loadingDiv.innerHTML = '<div style="max-width:80%;padding:12px 16px;border-radius:12px;background:white;border:1px solid #e5e7eb;color:#64748b;font-size:14px;">Analyzing your data<span class="loading-dots">...</span></div>';
        messagesDiv.appendChild(loadingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        try {
            // Get selected lessons only
            const selectedLessons = getSelectedLessons();
            if (selectedLessons.length === 0) {
                if (loadingDiv.parentNode) loadingDiv.remove();
                addAIAnalysisMessage('Please select at least one lesson to analyze.', false);
                return;
            }
            
            // Get current filter dates
            const fromDate = document.getElementById('progressFromDate').value;
            const toDate = document.getElementById('progressToDate').value;
            
            const response = await fetch('/api/progress/ask-question', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: question,
                    lessons: selectedLessons,
                    fromDate: fromDate,
                    toDate: toDate,
                    includeGoals: includeGoals
                })
            });
            
            if (!response.ok) throw new Error('Failed to get response');
            
            const data = await response.json();
            const answer = data.answer || 'No response generated';
            
            // Remove loading
            if (loadingDiv.parentNode) {
                loadingDiv.remove();
            }
            
            // Add AI response
            addAIAnalysisMessage(answer, false);
            
        } catch (error) {
            console.error('Error getting AI response:', error);
            if (loadingDiv.parentNode) {
                loadingDiv.remove();
            }
            addAIAnalysisMessage('Sorry, I encountered an error analyzing your data. Please try again.', false);
        }
    }
    
    async function toggleAIAnalysisRecording() {
        const micBtn = document.getElementById('aiAnalysisMicBtn');
        
        if (aiAnalysisRecording) {
            // Stop recording
            aiAnalysisRecording = false;
            micBtn.classList.remove('recording');
            // Restore microphone icon
            micBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:20px;height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v3m0 0h-3m3 0h3M8.25 9v3a3.75 3.75 0 007.5 0V9m-7.5 0A3.75 3.75 0 0112 5.25v0A3.75 3.75 0 0115.75 9v3A3.75 3.75 0 0112 15.75v0A3.75 3.75 0 018.25 12V9z" /></svg>';
            
            if (aiAnalysisRecorder) {
                aiAnalysisRecorder.stop();
            }
        } else {
            // Start recording
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                aiAnalysisRecorder = new MediaRecorder(stream);
                const chunks = [];
                
                aiAnalysisRecorder.ondataavailable = (e) => chunks.push(e.data);
                aiAnalysisRecorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    await transcribeAIAnalysisAudio(blob);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                aiAnalysisRecorder.start();
                aiAnalysisRecording = true;
                micBtn.classList.add('recording');
                // Change to stop icon
                micBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:20px;height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" /></svg>';
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }
    }
    
    async function transcribeAIAnalysisAudio(audioBlob) {
        try {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');
            
            const response = await fetch('/api/realtime/transcribe', {
                method: 'POST',
                body: audioBlob,
                headers: {
                    'Content-Type': 'audio/webm'
                }
            });
            
            if (!response.ok) throw new Error('Transcription failed');
            
            const data = await response.json();
            const transcription = data.text || '';
            
            if (transcription.trim()) {
                const input = document.getElementById('aiAnalysisInput');
                input.value = transcription;
                // Let user review and edit before sending
            }
            
        } catch (error) {
            console.error('Error transcribing audio:', error);
            alert('Failed to transcribe audio. Please try typing instead.');
        }
    }

    // Boot
    initializeMode();
    loadPedagogyPreferences(); // Load user preferences for pedagogy dashboard
    
    fetch('/api/video-metadata').then(r=>{ if(!r.ok) throw new Error('Cannot load metadata'); return r.json(); })
        .then(list=>{ metadataList=list; populateSelector(list); 
            var ident=getQueryParam('sessionId')||getQueryParam('id'); var chosen=findByIdOrSession(list, ident)||list[0]; if(chosen){ document.getElementById('videoSelect').value=chosen.sessionId; loadLesson(chosen); } 
        })
        .catch(e=>updateStatus(e.message));
    
    // Mode button click handlers
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            switchMode(btn.dataset.mode);
        });
    });
    
    // ========== RECORDING FUNCTIONALITY ==========
    
    // Recording state variables
    let mediaRecorder = null;
    let audioStream = null;
    let recordingChunks = [];
    let chunkNumber = 0;
    let recordingStartTime = null;
    let maxDurationSeconds = 3600; // Default 1 hour
    let timerInterval = null;
    let recordingSessionId = null;
    const CHUNK_INTERVAL = 300000; // 5 minutes in ms
    let chunkTimer = null;
    let accumulatedTranscript = [];
    
    // IndexedDB setup
    const DB_NAME = 'LessonRecordings';
    const DB_VERSION = 1;
    const STORE_NAME = 'chunks';
    
    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'key' });
                }
            };
        });
    }
    
    async function saveToIndexedDB(key, blob) {
        try {
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            await store.put({ key, blob, timestamp: Date.now() });
            console.log('✅ Saved chunk to IndexedDB:', key);
        } catch (error) {
            console.error('❌ IndexedDB save failed:', error);
        }
    }
    
    async function clearSessionFromIndexedDB(sessionId) {
        try {
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAllKeys();
            request.onsuccess = () => {
                const keys = request.result;
                keys.forEach(key => {
                    if (key.startsWith(sessionId)) {
                        store.delete(key);
                    }
                });
            };
        } catch (error) {
            console.error('❌ IndexedDB clear failed:', error);
        }
    }
    
    // Initialize recording view
    function initializeRecordView() {
        // Reset UI to initial state
        const recordBtn = document.getElementById('recordButton');
        recordBtn.classList.remove('recording-active');
        recordBtn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
        recordBtn.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.3)';
        document.getElementById('recordButtonText').textContent = 'RECORD';
        document.getElementById('timerDisplay').style.opacity = '0';
        document.getElementById('recordingStatus').style.opacity = '0';
        document.getElementById('recordingWarnings').style.opacity = '0';
        // Hide non-active blocks to avoid vertical gaps when not recording
        document.getElementById('timerDisplay').classList.add('hidden');
        document.getElementById('recordingStatus').classList.add('hidden');
        document.getElementById('recordingWarnings').classList.add('hidden');
        document.getElementById('processingIndicator').classList.add('hidden');
        document.getElementById('recordingComplete').classList.add('hidden');
        document.getElementById('recordDurationSelect').disabled = false;
        document.getElementById('transcriptDisplay').classList.add('hidden');
        
        // Refresh local recordings dropdown when entering the view
        refreshRecordingsDropdown().catch(() => {});
        
        // Check for incomplete recordings on page load (recovery feature)
        checkForIncompleteRecordings();
    }
    
    async function checkForIncompleteRecordings() {
        // Implementation for recovery - future enhancement
        console.log('Checking for incomplete recordings...');
    }
    
    // Start recording
    async function startRecording() {
        try {
            // Get selected duration
            maxDurationSeconds = parseInt(document.getElementById('recordDurationSelect').value);
            
            // Generate session ID
            recordingSessionId = `lesson_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            chunkNumber = 0;
            accumulatedTranscript = [];
            
            // Request microphone access
            audioStream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                } 
            });
            
            // Determine best supported MIME type
            const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') 
                ? 'audio/webm;codecs=opus' 
                : MediaRecorder.isTypeSupported('audio/mp4')
                    ? 'audio/mp4'
                    : 'audio/webm';
            
            console.log('🎤 Using MIME type:', mimeType);
            
            // Initialize MediaRecorder
            mediaRecorder = new MediaRecorder(audioStream, { 
                mimeType,
                audioBitsPerSecond: 128000
            });
            
            recordingChunks = [];
            
            // Handle data available event (chunks)
            mediaRecorder.ondataavailable = async (event) => {
                if (event.data.size > 0) {
                    recordingChunks.push(event.data);
                    console.log('📦 Chunk received:', event.data.size, 'bytes');
                }
            };
            
            // Handle recording stop
            mediaRecorder.onstop = async () => {
                console.log('🛑 Recording stopped, processing final chunk...');
                await processFinalChunk();
            };
            
            // Start recording
            mediaRecorder.start();
            recordingStartTime = Date.now();
            
            // Update UI - button becomes red and shows STOP
            const recordBtn = document.getElementById('recordButton');
            recordBtn.classList.add('recording-active');
            recordBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            recordBtn.style.boxShadow = '0 8px 32px rgba(239, 68, 68, 0.3)';
            document.getElementById('recordButtonText').textContent = 'STOP';
            document.getElementById('recordDurationSelect').disabled = true;
            // Show active blocks and restore display to remove gaps
            document.getElementById('timerDisplay').classList.remove('hidden');
            document.getElementById('recordingStatus').classList.remove('hidden');
            document.getElementById('recordingWarnings').classList.remove('hidden');
            document.getElementById('timerDisplay').style.opacity = '1';
            document.getElementById('recordingStatus').style.opacity = '1';
            document.getElementById('recordingWarnings').style.opacity = '1';
            
            // Format max duration display
            const hours = Math.floor(maxDurationSeconds / 3600);
            const minutes = Math.floor((maxDurationSeconds % 3600) / 60);
            const seconds = maxDurationSeconds % 60;
            document.getElementById('maxDurationText').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // Start timer
            startTimer();
            
            // Set up chunk interval (save every 5 minutes)
            chunkTimer = setInterval(() => {
                saveCurrentChunk();
            }, CHUNK_INTERVAL);
            
            // Auto-stop at max duration
            setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                }
            }, maxDurationSeconds * 1000);
            
        } catch (error) {
            console.error('❌ Recording start failed:', error);
            alert('Failed to start recording. Please check microphone permissions.');
            resetRecordingUI();
        }
    }
    
    // Save current chunk
    async function saveCurrentChunk() {
        if (!mediaRecorder || mediaRecorder.state !== 'recording') return;
        
        console.log('💾 Saving chunk', chunkNumber);
        
        // Request data (triggers ondataavailable)
        mediaRecorder.stop();
        
        // Process the chunk
        await processChunk();
        
        // Restart recording for next chunk
        recordingChunks = [];
        mediaRecorder.start();
    }
    
    // Process chunk (save and upload)
    async function processChunk() {
        if (recordingChunks.length === 0) return;
        
        const chunkBlob = new Blob(recordingChunks, { type: mediaRecorder.mimeType });
        const currentChunkNum = chunkNumber++;
        
        // Save to IndexedDB
        await saveToIndexedDB(`${recordingSessionId}_chunk_${currentChunkNum}`, chunkBlob);
        
        // Upload to server for transcription
        uploadChunkForTranscription(chunkBlob, currentChunkNum);
        
        // Update status
        document.getElementById('saveStatusText').textContent = `Saved ${currentChunkNum + 1} chunk(s)`;
    }
    
    // Process final chunk when recording stops
    async function processFinalChunk() {
        if (recordingChunks.length === 0) {
            showRecordingComplete();
            return;
        }
        
        const chunkBlob = new Blob(recordingChunks, { type: mediaRecorder.mimeType });
        const currentChunkNum = chunkNumber++;
        
        console.log('📤 Processing final chunk:', currentChunkNum);
        
        // Save to IndexedDB
        await saveToIndexedDB(`${recordingSessionId}_chunk_${currentChunkNum}`, chunkBlob);
        
        // Upload final chunk
        await uploadChunkForTranscription(chunkBlob, currentChunkNum, true);
        
        // Show processing indicator
        document.getElementById('processingIndicator').classList.remove('hidden');
        
        // Wait a moment for server processing, then show complete
        setTimeout(() => {
            showRecordingComplete();
        }, 2000);
    }
    
    // Upload chunk to server for transcription
    async function uploadChunkForTranscription(blob, chunkNum, isFinal = false) {
        try {
            const formData = new FormData();
            formData.append('audio', blob);
            formData.append('sessionId', recordingSessionId);
            formData.append('chunkNumber', chunkNum);
            formData.append('isFinal', isFinal);
            formData.append('mimeType', mediaRecorder.mimeType);
            
            console.log('📤 Uploading chunk', chunkNum, 'to server...');
            
            const response = await fetch('/api/recording/transcribe-chunk', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            console.log('✅ Chunk', chunkNum, 'transcribed successfully');
            
            // Accumulate transcript
            if (data.transcript) {
                accumulatedTranscript.push({
                    chunkNumber: chunkNum,
                    transcript: data.transcript
                });
                document.getElementById('uploadStatusText').textContent = `Transcribed ${accumulatedTranscript.length} chunk(s)`;
                
                // Show transcript display if not already visible
                const transcriptDisplay = document.getElementById('transcriptDisplay');
                if (transcriptDisplay.classList.contains('hidden')) {
                    transcriptDisplay.classList.remove('hidden');
                }
                
                // Update transcript text
                const fullTranscript = accumulatedTranscript
                    .sort((a, b) => a.chunkNumber - b.chunkNumber)
                    .map(t => t.transcript)
                    .join(' ');
                document.getElementById('transcriptText').textContent = fullTranscript;
                
                // Auto-scroll to bottom
                document.getElementById('transcriptText').scrollTop = document.getElementById('transcriptText').scrollHeight;
            }
            
        } catch (error) {
            console.error('❌ Chunk upload failed:', error);
            // Don't alert user - chunks are safely stored in IndexedDB
            document.getElementById('uploadStatusText').textContent = 'Upload pending (will retry)';
        }
    }
    
    // Stop recording
    async function stopRecording() {
        console.log('🛑 Stopping recording...');
        
        // Stop timers
        if (timerInterval) clearInterval(timerInterval);
        if (chunkTimer) clearInterval(chunkTimer);
        
        // Stop MediaRecorder (this will trigger onstop event)
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        
        // Stop audio stream
        if (audioStream) {
            audioStream.getTracks().forEach(track => track.stop());
        }
    }
    
    // Start timer display
    function startTimer() {
        timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            updateTimerDisplay(elapsed);
            
            // Auto-stop if max duration reached
            if (elapsed >= maxDurationSeconds) {
                stopRecording();
            }
        }, 1000);
    }
    
    // Update timer display
    function updateTimerDisplay(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        document.getElementById('timerText').textContent = 
            hours > 0 
                ? `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`
                : `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    
    // Show recording complete
    function showRecordingComplete() {
        // Generate base file-safe name for server download button
        const now = new Date();
        const filename = `Lesson_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
        document.getElementById('recordingName').textContent = filename;
        document.getElementById('processingIndicator').classList.add('hidden');
        document.getElementById('recordingComplete').classList.remove('hidden');
        document.getElementById('recordingStatus').style.opacity = '0';
        document.getElementById('recordingWarnings').style.opacity = '0';
        // Hide these to collapse vertical space after recording completes
        document.getElementById('timerDisplay').classList.add('hidden');
        document.getElementById('recordingStatus').classList.add('hidden');
        document.getElementById('recordingWarnings').classList.add('hidden');
        
        // Reset button to blue "RECORD"
        const recordBtn = document.getElementById('recordButton');
        recordBtn.classList.remove('recording-active');
        recordBtn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
        recordBtn.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.3)';
        document.getElementById('recordButtonText').textContent = 'RECORD';
        document.getElementById('recordDurationSelect').disabled = false;
        document.getElementById('timerDisplay').style.opacity = '0';
        
        // Hide live transcript display
        document.getElementById('transcriptDisplay').classList.add('hidden');
        
        // Show final transcript in complete state
        const fullTranscript = accumulatedTranscript
            .sort((a, b) => a.chunkNumber - b.chunkNumber)
            .map(t => t.transcript)
            .join(' ');
        document.getElementById('finalTranscriptText').textContent = fullTranscript || 'No transcript available';
        
        // Store session ID for download
        document.getElementById('downloadRecordingBtn').dataset.sessionId = recordingSessionId;

        // Trigger local save to OPFS and refresh dropdown
        try {
            saveSessionLocally(recordingSessionId).then(() => {
                refreshRecordingsDropdown();
            });
        } catch (e) {
            console.error('Local save failed:', e);
        }
    }
    
    // Reset recording UI
    function resetRecordingUI() {
        const recordBtn = document.getElementById('recordButton');
        recordBtn.classList.remove('recording-active');
        recordBtn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
        recordBtn.style.boxShadow = '0 8px 24px rgba(59, 130, 246, 0.3)';
        document.getElementById('recordDurationSelect').disabled = false;
        document.getElementById('recordButtonText').textContent = 'RECORD';
        document.getElementById('timerDisplay').style.opacity = '0';
        document.getElementById('recordingStatus').style.opacity = '0';
        document.getElementById('recordingWarnings').style.opacity = '0';
        document.getElementById('timerDisplay').classList.add('hidden');
        document.getElementById('recordingStatus').classList.add('hidden');
        document.getElementById('recordingWarnings').classList.add('hidden');
        document.getElementById('transcriptDisplay').classList.add('hidden');
        document.getElementById('processingIndicator').classList.add('hidden');
        document.getElementById('recordingComplete').classList.add('hidden');
        
        // Clear transcript
        accumulatedTranscript = [];
        document.getElementById('transcriptText').textContent = 'Waiting for transcription...';
        
        if (timerInterval) clearInterval(timerInterval);
        if (chunkTimer) clearInterval(chunkTimer);
    }
    
    // Download recording
    async function downloadRecording() {
        const sessionId = document.getElementById('downloadRecordingBtn').dataset.sessionId;
        if (!sessionId) return;
        
        try {
            const response = await fetch(`/api/recording/download/${sessionId}`);
            if (!response.ok) throw new Error('Download failed');
            
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = document.getElementById('recordingName').textContent + '.mp3';
            a.click();
            URL.revokeObjectURL(url);
            
        } catch (error) {
            console.error('❌ Download failed:', error);
            alert('Failed to download recording. Please try again.');
        }
    }

    // ===== Local PWA Drive Helpers (OPFS) =====
    async function getPwaRoot() {
        if (!('storage' in navigator) || !navigator.storage.getDirectory) {
            throw new Error('OPFS is not supported in this browser');
        }
        return await navigator.storage.getDirectory();
    }

    function formatDisplayLabel(date) {
        const dd = String(date.getDate()).padStart(2, '0');
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const yyyy = date.getFullYear();
        const hh = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        return `Lesson Recording — ${dd}/${mm}/${yyyy} - ${hh}:${min}`;
    }

    async function getSessionChunks(sessionId) {
        const db = await openDB();
        return await new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.getAll();
            req.onerror = () => reject(req.error);
            req.onsuccess = () => {
                const records = (req.result || [])
                    .filter(r => typeof r.key === 'string' && r.key.startsWith(sessionId + '_chunk_'))
                    .sort((a, b) => parseInt(a.key.split('_chunk_')[1]) - parseInt(b.key.split('_chunk_')[1]))
                    .map(r => r.blob);
                resolve(records);
            };
        });
    }

    async function saveSessionLocally(sessionId) {
        const statusEl = document.getElementById('localSaveStatus');
        const audioEl = document.getElementById('localPlaybackAudio');
        try {
            statusEl.textContent = 'Saving a copy to your device…';
            const chunks = await getSessionChunks(sessionId);
            // Fallback: if nothing in IndexedDB (edge case), use in-memory final chunk
            const blobs = chunks && chunks.length > 0 ? chunks : (recordingChunks.length ? [new Blob(recordingChunks, { type: mediaRecorder?.mimeType || 'audio/webm' })] : []);
            if (!blobs.length) {
                statusEl.textContent = 'Nothing to save.';
                return;
            }

            // Concatenate all chunks into one Blob. Type set to mp3 for requested format.
            const combined = new Blob(blobs, { type: 'audio/mp3' });

            // Create filename and persist to OPFS root
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            const filename = `lesson_${y}-${m}-${d}_${hh}-${mm}-${ss}.mp3`;

            const root = await getPwaRoot();
            const handle = await root.getFileHandle(filename, { create: true });
            const writable = await handle.createWritable();
            await writable.write(combined);
            await writable.close();

            // Show playback and status
            const url = URL.createObjectURL(await (await handle.getFile()));
            audioEl.src = url;
            audioEl.style.display = 'block';
            statusEl.textContent = `Saved locally as ${filename}`;
        } catch (err) {
            console.error(err);
            statusEl.textContent = 'Failed to save locally.';
        }
    }

    async function refreshRecordingsDropdown() {
        const dropdowns = [
            document.getElementById('recordingsDropdown'),
            document.getElementById('recordingsDropdownTop')
        ].filter(Boolean);
        if (dropdowns.length === 0) return;
        dropdowns.forEach(d => d.innerHTML = '');
        try {
            const root = await getPwaRoot();
            const items = [];
            for await (const [name, handle] of root.entries()) {
                if (name.endsWith('.mp3')) {
                    const file = await handle.getFile();
                    items.push({ name, handle, date: new Date(file.lastModified) });
                }
            }
            // Sort newest first
            items.sort((a, b) => b.date - a.date);
            // Populate options
            dropdowns.forEach(dropdown => {
                for (const item of items) {
                    const opt = document.createElement('option');
                    opt.value = item.name;
                    opt.textContent = formatDisplayLabel(item.date);
                    dropdown.appendChild(opt);
                }
                if (items.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No recordings found';
                    dropdown.appendChild(opt);
                }
            });
        } catch (e) {
            console.error('Failed to list recordings:', e);
            dropdowns.forEach(dropdown => {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'No recordings found';
                dropdown.appendChild(opt);
            });
        }
    }

    async function loadRecordingByName(name, audioElementId) {
        if (!name) return;
        try {
            const root = await getPwaRoot();
            const handle = await root.getFileHandle(name);
            const file = await handle.getFile();
            const url = URL.createObjectURL(file);
            const targetId = audioElementId || 'localPlaybackAudio';
            const audioEl = document.getElementById(targetId);
            if (!audioEl) return;
            audioEl.src = url;
            audioEl.style.display = 'block';
            audioEl.play().catch(() => {});
            const statusEl = document.getElementById('localSaveStatus');
            if (statusEl && targetId === 'localPlaybackAudio') {
                statusEl.textContent = `Loaded ${name}`;
            }
        } catch (e) {
            console.error('Load failed:', e);
        }
    }
    
    // Function to show stop recording confirmation modal
    function showStopRecordingModal() {
        // Calculate and display current recording duration
        if (recordingStartTime) {
            const elapsedSeconds = Math.floor((Date.now() - recordingStartTime) / 1000);
            const hours = Math.floor(elapsedSeconds / 3600);
            const minutes = Math.floor((elapsedSeconds % 3600) / 60);
            const seconds = elapsedSeconds % 60;
            document.getElementById('modalRecordedDuration').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // Show modal
        document.getElementById('stopRecordingModal').classList.remove('hidden');
    }
    
    // Function to hide stop recording modal
    function hideStopRecordingModal() {
        document.getElementById('stopRecordingModal').classList.add('hidden');
    }
    
    // Record button event listener
    // Record button toggles between start and stop
    document.getElementById('recordButton').addEventListener('click', () => {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            startRecording();
        } else {
            showStopRecordingModal();
        }
    });
    
    // Load selected local recording
    const recordingsDropdownEl = document.getElementById('recordingsDropdown');
    if (recordingsDropdownEl) {
        recordingsDropdownEl.addEventListener('change', (e) => {
            const name = e.target.value;
            if (name) loadRecordingByName(name);
        });
    }
    const recordingsDropdownTopEl = document.getElementById('recordingsDropdownTop');
    if (recordingsDropdownTopEl) {
        recordingsDropdownTopEl.addEventListener('change', (e) => {
            const name = e.target.value;
            if (name) loadRecordingByName(name, 'topPlaybackAudio');
        });
    }
    const loadRecordingTopBtn = document.getElementById('loadRecordingTopBtn');
    if (loadRecordingTopBtn && recordingsDropdownTopEl) {
        loadRecordingTopBtn.addEventListener('click', () => {
            const name = recordingsDropdownTopEl.value;
            if (name) loadRecordingByName(name, 'topPlaybackAudio');
        });
    }

    // Initial population on page load
    refreshRecordingsDropdown().catch(() => {});
    document.getElementById('downloadRecordingBtn').addEventListener('click', downloadRecording);
    document.getElementById('newRecordingBtn').addEventListener('click', () => {
        resetRecordingUI();
        // Clear IndexedDB for this session
        if (recordingSessionId) {
            clearSessionFromIndexedDB(recordingSessionId);
        }
    });
    
    // Stop recording modal event listeners
    document.getElementById('cancelStopRecording').addEventListener('click', hideStopRecordingModal);
    document.getElementById('confirmStopRecording').addEventListener('click', () => {
        hideStopRecordingModal();
        stopRecording();
    });
    
    // Close modal on backdrop click
    document.getElementById('stopRecordingModal').addEventListener('click', (e) => {
        if (e.target.id === 'stopRecordingModal') {
            hideStopRecordingModal();
        }
    });
    
    // Prevent page unload during recording
    window.addEventListener('beforeunload', (e) => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            e.preventDefault();
            e.returnValue = 'Recording in progress. Are you sure you want to leave?';
        }
    });
    
    // ========== END RECORDING FUNCTIONALITY ==========
    
    // Onboarding chat event listeners
    document.getElementById('onboardingSendBtn').addEventListener('click', sendOnboardingMessage);
    document.getElementById('onboardingInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendOnboardingMessage();
        }
    });
    document.getElementById('onboardingMicBtn').addEventListener('click', toggleOnboardingMic);
    
    // Pedagogy settings modal listeners
    document.getElementById('pedagogySettingsBtn').addEventListener('click', openPedagogySettings);
    document.getElementById('closeSettingsModal').addEventListener('click', closePedagogySettings);
    document.getElementById('cancelSettings').addEventListener('click', closePedagogySettings);
    document.getElementById('saveSettings').addEventListener('click', saveAndClosePedagogySettings);
    document.getElementById('pedagogySettingsModal').addEventListener('click', function(e) {
        if (e.target.id === 'pedagogySettingsModal') closePedagogySettings();
    });
    
    // Progress filter listener
    document.getElementById('applyProgressFilters').addEventListener('click', () => loadProgressView(true));
    
    document.getElementById('saveResearchBtn').addEventListener('click', saveResearchChanges);

    // Tab switching
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.right-content').forEach(c => c.classList.add('hidden'));
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById(tabName + 'Content').classList.remove('hidden');
    }

    document.getElementById('videoSelect').addEventListener('change', function(){ const sessionId=this.value; const chosen=findByIdOrSession(metadataList, sessionId); if(!chosen) return; const url=new URL(window.location.href); url.searchParams.set('sessionId', chosen.sessionId); url.searchParams.delete('id'); history.replaceState({}, '', url); loadLesson(chosen); });
    document.getElementById('micBtn').addEventListener('click', toggleMic);
    document.getElementById('sendBtn').addEventListener('click', sendPrompt);
    document.getElementById('chatInput').addEventListener('keydown', function(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendPrompt(); }});
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            switchTab(tab.dataset.tab);
            if(tab.dataset.tab==='flagged' && currentMeta){
                loadFlaggedView(currentMeta.sessionId);
            }
            if(tab.dataset.tab==='pedagogy' && currentMeta){
                loadPedagogyView(currentMeta.sessionId);
            }
        });
    });

    var tag=document.createElement('script'); tag.src='https://developers.panopto.com/scripts/embedapi.min.js'; var firstScriptTag=document.getElementsByTagName('script')[0]; firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    
    // Divider drag logic
    (function(){
        var divider = document.getElementById('divider');
        var left = document.getElementById('leftPanel');
        if(!divider || !left) return;
        var dragging=false; var startX=0; var startWidth=0; var main=document.querySelector('.main');
        function onDown(e){ dragging=true; startX=(e.touches?e.touches[0].clientX:e.clientX); startWidth=left.getBoundingClientRect().width; document.body.style.userSelect='none'; }
        function onMove(e){ if(!dragging) return; var x=(e.touches?e.touches[0].clientX:e.clientX); var dx=x-startX; var total=main.getBoundingClientRect().width; var newW=Math.min(Math.max(startWidth+dx, total*0.35), total*0.75); left.style.flex=`0 0 ${newW}px`; }
        function onUp(){ dragging=false; document.body.style.userSelect=''; }
        divider.addEventListener('mousedown', onDown); divider.addEventListener('touchstart', onDown, {passive:true});
        window.addEventListener('mousemove', onMove); window.addEventListener('touchmove', onMove, {passive:false});
        window.addEventListener('mouseup', onUp); window.addEventListener('touchend', onUp);
    })();
    
    // ========== PWA SERVICE WORKER & INSTALL ==========
    
    // Register Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then((registration) => {
                    console.log('✅ Service Worker registered:', registration.scope);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('🔄 Service Worker update found');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New service worker available
                                showUpdateNotification();
                            }
                        });
                    });
                })
                .catch((error) => {
                    console.error('❌ Service Worker registration failed:', error);
                });
        });
    }
    
    // PWA Install Prompt
    let deferredPrompt = null;
    const installButton = document.createElement('button');
    installButton.id = 'installPWABtn';
    installButton.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Install App
    `;
    installButton.style.cssText = 'display:none;padding:8px 14px;background:#10b981;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;align-items:center;';
    installButton.onmouseover = () => installButton.style.background = '#059669';
    installButton.onmouseout = () => installButton.style.background = '#10b981';
    
    // Add to topbar actions
    const topbarActions = document.querySelector('.actions');
    if (topbarActions) {
        topbarActions.appendChild(installButton);
    }
    
    // Capture install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show install button
        installButton.style.display = 'flex';
        console.log('📱 PWA install prompt available');
    });
    
    // Handle install button click
    installButton.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        console.log(`📱 User ${outcome} the install prompt`);
        
        if (outcome === 'accepted') {
            installButton.style.display = 'none';
        }
        
        deferredPrompt = null;
    });
    
    // Handle successful install
    window.addEventListener('appinstalled', () => {
        console.log('✅ PWA installed successfully');
        installButton.style.display = 'none';
        deferredPrompt = null;
        
        // Show success message
        alert('Teach(er) installed successfully! You can now use it like a native app.');
    });
    
    // Check if already installed
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
        console.log('✅ Running as installed PWA');
        installButton.style.display = 'none';
    }
    
    // Show update notification
    function showUpdateNotification() {
        const updateBanner = document.createElement('div');
        updateBanner.style.cssText = 'position:fixed;top:80px;right:20px;background:#3b82f6;color:white;padding:16px 20px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.2);z-index:9999;display:flex;align-items:center;gap:12px;animation:slideInRight 0.3s ease;';
        updateBanner.innerHTML = `
            <div style="flex:1;">
                <div style="font-weight:600;margin-bottom:4px;">Update Available</div>
                <div style="font-size:13px;opacity:0.9;">A new version of Teach(er) is ready</div>
            </div>
            <button id="updateNowBtn" style="padding:8px 16px;background:white;color:#3b82f6;border:none;border-radius:6px;font-weight:600;cursor:pointer;">
                Update Now
            </button>
            <button id="dismissUpdateBtn" style="padding:8px;background:transparent;color:white;border:none;cursor:pointer;opacity:0.8;">✕</button>
        `;
        
        document.body.appendChild(updateBanner);
        
        document.getElementById('updateNowBtn').addEventListener('click', () => {
            navigator.serviceWorker.getRegistration().then((reg) => {
                if (reg && reg.waiting) {
                    reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                }
            });
        });
        
        document.getElementById('dismissUpdateBtn').addEventListener('click', () => {
            updateBanner.remove();
        });
        
        // Auto-dismiss after 10 seconds
        setTimeout(() => {
            if (updateBanner.parentElement) {
                updateBanner.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => updateBanner.remove(), 300);
            }
        }, 10000);
    }
    
    // Add animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
    
    // ========== END PWA ==========
    
    </script>
</body>
</html>
